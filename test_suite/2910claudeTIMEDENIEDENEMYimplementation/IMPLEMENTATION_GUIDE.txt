# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPLETE IMPLEMENTATION GUIDE
# How to update !last_session to remove HSK and add Time Denied
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"""
This file shows the EXACT changes needed in bot/ultimate_bot.py
Search for the code sections and replace them with the updated versions below.
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1: Update the SQL query to include denied_playtime
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SEARCH FOR (around line 1400-1450 in ultimate_bot.py):
"""
                query = f'''
                    SELECT p.player_name,
                           SUM(p.kills) as kills,
                           SUM(p.deaths) as deaths,
                           CASE
                               WHEN SUM(p.time_played_seconds) > 0
                               THEN (SUM(p.damage_given) * 60.0) / SUM(p.time_played_seconds)
                               ELSE 0
                           END as weighted_dpm,
                           COALESCE(SUM(w.hits), 0) as total_hits,
                           COALESCE(SUM(w.shots), 0) as total_shots,
                           COALESCE(SUM(w.headshots), 0) as total_headshots,
                           SUM(p.headshot_kills) as headshot_kills,
                           SUM(p.time_played_seconds) as total_seconds,
                           CAST(SUM(p.time_played_seconds * p.time_dead_ratio / 100.0) AS INTEGER) as total_time_dead
                    FROM player_comprehensive_stats p
"""

# REPLACE WITH (add the denied_playtime line):
"""
                query = f'''
                    SELECT p.player_name,
                           SUM(p.kills) as kills,
                           SUM(p.deaths) as deaths,
                           CASE
                               WHEN SUM(p.time_played_seconds) > 0
                               THEN (SUM(p.damage_given) * 60.0) / SUM(p.time_played_seconds)
                               ELSE 0
                           END as weighted_dpm,
                           COALESCE(SUM(w.hits), 0) as total_hits,
                           COALESCE(SUM(w.shots), 0) as total_shots,
                           COALESCE(SUM(w.headshots), 0) as total_headshots,
                           SUM(p.headshot_kills) as headshot_kills,
                           SUM(p.time_played_seconds) as total_seconds,
                           CAST(SUM(p.time_played_seconds * p.time_dead_ratio / 100.0) AS INTEGER) as total_time_dead,
                           SUM(p.denied_playtime) as total_denied
                    FROM player_comprehensive_stats p
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 2: Update the player unpacking to include denied time
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SEARCH FOR (around line 1480-1490):
"""
                for i, player in enumerate(all_players):
                    name, kills, deaths, dpm, hits, shots = player[0:6]
                    total_hs, hsk, total_seconds, total_time_dead = player[6:10]
"""

# REPLACE WITH:
"""
                for i, player in enumerate(all_players):
                    name, kills, deaths, dpm, hits, shots = player[0:6]
                    total_hs, hsk, total_seconds, total_time_dead, total_denied = player[6:11]
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 3: Add variables to handle denied time
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SEARCH FOR (right after the variable assignments):
"""
                    hsk = hsk or 0
                    total_seconds = total_seconds or 0

                    # Convert seconds to MM:SS format
"""

# ADD BEFORE "Convert seconds to MM:SS format":
"""
                    hsk = hsk or 0
                    total_seconds = total_seconds or 0
                    total_denied = int(total_denied or 0)  # NEW: Handle denied playtime

                    # Convert seconds to MM:SS format
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 4: Add the denied time display calculation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SEARCH FOR (after time_dead_display):
"""
                    # Calculate time dead
                    time_dead_seconds = int(total_time_dead or 0)
                    dead_minutes = int(time_dead_seconds // 60)
                    dead_seconds = int(time_dead_seconds % 60)
                    time_dead_display = f"{dead_minutes}:{dead_seconds:02d}"

                    # Calculate metrics
"""

# ADD BEFORE "Calculate metrics" (keep the existing code above, just add this):
"""
                    # Calculate time dead
                    time_dead_seconds = int(total_time_dead or 0)
                    dead_minutes = int(time_dead_seconds // 60)
                    dead_seconds = int(time_dead_seconds % 60)
                    time_dead_display = f"{dead_minutes}:{dead_seconds:02d}"

                    # Calculate time denied (NEW)
                    denied_minutes = int(total_denied // 60)
                    denied_seconds = int(total_denied % 60)
                    time_denied_display = f"{denied_minutes}:{denied_seconds:02d}"

                    # Calculate metrics
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5: Update the display to remove HSK and add Time Denied
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SEARCH FOR (the player display section):
"""
                    # Line 2: Advanced stats with time alive and time dead
                    top_text += (
                        f"`{hsk} HSK ({hsk_rate:.1f}%)` â€¢ "
                        f"`{total_hs} HS ({hs_rate:.1f}%)` â€¢ "
                        f"â±ï¸ `{time_display}` â€¢ ğŸ’€ `{time_dead_display}`\n\n"
                    )
"""

# REPLACE WITH (remove HSK, add denied time):
"""
                    # Line 2: Time stats and headshots (UPDATED: removed HSK, added time denied)
                    top_text += (
                        f"`{total_hs} HS ({hs_rate:.1f}%)` â€¢ "
                        f"â±ï¸ `{time_display}` â€¢ ğŸ’€ `{time_dead_display}` â€¢ â³ `{time_denied_display}`\n\n"
                    )
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OPTIONAL: Remove the HSK calculation if you want
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# You can remove or comment out this line since we're not displaying HSK anymore:
"""
                    # HSK rate = headshot kills / total kills
                    hsk_rate = (hsk / kills * 100) if kills and kills > 0 else 0
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTING CHECKLIST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
After making these changes, test:

1. Run !last_session command
2. Verify output shows:
   âœ“ Kills/Deaths/KD ratio
   âœ“ DPM (Damage Per Minute)
   âœ“ ACC (Accuracy)
   âœ“ HS (Headshots) with percentage
   âœ“ â±ï¸ Time Played in MM:SS
   âœ“ ğŸ’€ Time Dead in MM:SS
   âœ“ â³ Time Denied in MM:SS (NEW!)
   âœ— NO HSK (Headshot Kills) - should be removed

3. Check that times make sense:
   - Time Denied should usually be less than Time Dead
   - All times should be in MM:SS format
   - No crashes or errors

Example expected output:
```
ğŸ¥‡ **vid**
`183K/138D (1.41)` â€¢ `284 DPM` â€¢ `39.2% ACC (1498/3819)`
`269 HS (114.2%)` â€¢ â±ï¸ `114:36` â€¢ ğŸ’€ `23:26` â€¢ â³ `5:12`
```

WHAT EACH STAT MEANS:
- HS: Total headshots landed
- â±ï¸ Time Played: Total active playing time
- ğŸ’€ Time Dead: Total time spent waiting to respawn
- â³ Time Denied: Total time you denied enemies from respawning
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TROUBLESHOOTING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
If you get errors:

ERROR: "list index out of range"
FIX: Make sure you updated the unpacking line to include total_denied:
     total_hs, hsk, total_seconds, total_time_dead, total_denied = player[6:11]

ERROR: "denied_playtime column not found"
FIX: The column name in your database might be different. Check with:
     sqlite3 your_database.db "PRAGMA table_info(player_comprehensive_stats);"
     Look for the exact column name for denied playtime.

ERROR: Times showing as negative
FIX: Make sure you're using int() and have the "or 0" fallback:
     total_denied = int(total_denied or 0)
"""
