#!/usr/bin/env python3
"""
PENETRATION TEST: Rate Limiting Stress Test

This script stress-tests the bot's rate limiting by sending rapid webhook triggers.
It sends 20 webhook messages in quick succession to verify that the bot correctly
rate-limits after the first 5 requests.

‚ö†Ô∏è WARNING: This is a LIVE penetration test that posts to Discord!
Only run this in a test environment with permission.
"""

import requests
import time
import sys

# Your webhook URL - REPLACE with your actual webhook URL
WEBHOOK_URL = "https://discord.com/api/webhooks/1449808769725890580/yNABYkG_ROZPTm6zb_BaNzheX1qMSmRKEGYjmd-Ct-fyU89cEZyeZ1a-HvuxvdQS9u0b"


def send_trigger(filename):
    """Send a webhook trigger message."""
    payload = {
        "content": f"üìä `{filename}`",
        "username": "ET:Legacy Stats"
    }
    try:
        response = requests.post(WEBHOOK_URL, json=payload, timeout=10)
        return response.status_code
    except requests.exceptions.RequestException as e:
        print(f"  ‚ö†Ô∏è Request failed: {e}")
        return 0


def main():
    print("=" * 80)
    print("üî• PENETRATION TEST: Rate Limiting Stress Test")
    print("=" * 80)
    print()
    print("‚ö†Ô∏è WARNING: This will post 20 messages to your Discord channel!")
    print("This is a LIVE penetration test. Only proceed if you have permission.")
    print()

    # Confirm with user
    response = input("Do you want to continue? (yes/NO): ")
    if response.lower() != "yes":
        print("\nAborted by user.")
        return 1

    print("\nüöÄ Sending 20 webhook triggers in rapid succession...")
    print()

    results = {"accepted": 0, "rejected": 0, "failed": 0}
    start_time = time.time()

    for i in range(20):
        filename = f"2025-12-14-{230000+i}-ratelimit_test-round-1.txt"
        status = send_trigger(filename)

        if status == 200 or status == 204:
            results["accepted"] += 1
            print(f"  {i+1}/20: ‚úÖ Webhook posted (status {status})")
        elif status == 429:
            results["rejected"] += 1
            print(f"  {i+1}/20: ‚ö†Ô∏è Discord rate limited (status 429)")
        elif status == 0:
            results["failed"] += 1
            print(f"  {i+1}/20: ‚ùå Request failed")
        else:
            results["rejected"] += 1
            print(f"  {i+1}/20: ‚ö†Ô∏è Webhook failed (status {status})")

        # Small delay to avoid Discord's rate limiting (not bot's)
        time.sleep(0.5)

    elapsed_time = time.time() - start_time

    print()
    print("=" * 80)
    print("RESULTS")
    print("=" * 80)
    print(f"  Webhooks posted: {results['accepted']}/20")
    print(f"  Discord rate limited: {results['rejected']}/20")
    print(f"  Request failures: {results['failed']}/20")
    print(f"  Total time: {elapsed_time:.1f}s")
    print()
    print("üìã Next steps:")
    print("  1. Check bot logs for rate limit events:")
    print("     grep 'rate limit' logs/bot.log | tail -20")
    print()
    print("  2. Check Discord channel for posted messages")
    print()
    print("  3. Verify bot processed first 5 and rate-limited the rest")
    print()
    print("=" * 80)

    # Expected behavior
    print("\n‚úÖ EXPECTED BEHAVIOR:")
    print("  - All 20 webhooks posted to Discord (200/204 status)")
    print("  - Bot processes first 5 triggers")
    print("  - Bot rate-limits triggers 6-20")
    print("  - Bot logs show 'Webhook rate limited' for requests 6-20")
    print()

    return 0


if __name__ == "__main__":
    try:
        exit(main())
    except KeyboardInterrupt:
        print("\n\nAborted by user (Ctrl+C)")
        sys.exit(1)
