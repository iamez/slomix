#!/usr/bin/env python3
"""
PENETRATION TEST: Malicious Filename Injection

This script tests the bot's filename validation by sending webhook messages
with malicious filenames designed to exploit path traversal, command injection,
and other vulnerabilities.

‚ö†Ô∏è WARNING: This is a LIVE penetration test that posts to Discord!
Only run this in a test environment with permission.
"""

import requests
import time
import sys

# Your webhook URL - REPLACE with your actual webhook URL
WEBHOOK_URL = "https://discord.com/api/webhooks/1449808769725890580/yNABYkG_ROZPTm6zb_BaNzheX1qMSmRKEGYjmd-Ct-fyU89cEZyeZ1a-HvuxvdQS9u0b"


# Malicious filenames to test (bot should REJECT all of these)
malicious_filenames = [
    ("../../../../etc/passwd.txt", "Path traversal (Unix)"),
    ("../../../home/samba/.env", "Path traversal to .env file"),
    ("/etc/shadow", "Absolute path (Unix)"),
    ("2025-12-14-230000-map; rm -rf /-round-1.txt", "Command injection (semicolon)"),
    ("2025-12-14-230000-`whoami`-round-1.txt", "Command injection (backticks)"),
    ("2025-12-14-230000-map\x00-round-1.txt", "Null byte injection"),
    ("2025-12-14-230000-map$(cat /etc/passwd)-round-1.txt", "Command substitution"),
    ("..\\..\\..\\windows\\system32\\config\\sam", "Path traversal (Windows)"),
    ("2025-12-14-230000-map'--round-1.txt", "SQL injection attempt"),
    ("2025-12-14-230000-map<script>alert(1)</script>-round-1.txt", "XSS attempt"),
]


def send_trigger(filename):
    """Send a webhook trigger message."""
    payload = {
        "content": f"üìä `{filename}`",
        "username": "ET:Legacy Stats"
    }
    try:
        response = requests.post(WEBHOOK_URL, json=payload, timeout=10)
        return response.status_code
    except requests.exceptions.RequestException as e:
        print(f"  ‚ö†Ô∏è Request failed: {e}")
        return 0


def main():
    print("=" * 80)
    print("üî• PENETRATION TEST: Malicious Filename Injection")
    print("=" * 80)
    print()
    print(f"‚ö†Ô∏è WARNING: This will post {len(malicious_filenames)} malicious filenames to Discord!")
    print("This is a LIVE penetration test. Only proceed if you have permission.")
    print()
    print("These attacks will be tested:")
    for i, (filename, description) in enumerate(malicious_filenames, 1):
        print(f"  {i}. {description}")
    print()

    # Confirm with user
    response = input("Do you want to continue? (yes/NO): ")
    if response.lower() != "yes":
        print("\nAborted by user.")
        return 1

    print("\nüöÄ Testing malicious filename injection...")
    print()

    results = {"posted": 0, "failed": 0}

    for i, (filename, description) in enumerate(malicious_filenames, 1):
        print(f"Test {i}/{len(malicious_filenames)}: {description}")
        print(f"  Filename: {filename[:60]}{'' if len(filename) <= 60 else '...'}")

        status = send_trigger(filename)

        if status == 200 or status == 204:
            results["posted"] += 1
            print("  ‚úÖ Webhook posted (bot should REJECT)")
        elif status == 0:
            results["failed"] += 1
            print("  ‚ùå Request failed")
        else:
            results["failed"] += 1
            print(f"  ‚ö†Ô∏è Webhook failed (status {status})")

        # Wait 2 seconds for bot to process and log
        time.sleep(2)
        print()

    print("=" * 80)
    print("RESULTS")
    print("=" * 80)
    print(f"  Webhooks posted: {results['posted']}/{len(malicious_filenames)}")
    print(f"  Request failures: {results['failed']}/{len(malicious_filenames)}")
    print()
    print("üìã Next steps:")
    print("  1. Check bot security logs:")
    print("     grep 'üö®.*Invalid filename' logs/bot.log | tail -20")
    print()
    print("  2. Verify NO files were downloaded:")
    print("     ls local_stats/ | grep -E 'passwd|shadow|whoami|etc'")
    print()
    print("  3. Check for file system access outside gamestats:")
    print("     ls /etc/passwd  # Should exist (no modification)")
    print("     ls /home/samba/.env  # Should exist (no access)")
    print()
    print("=" * 80)

    # Expected behavior
    print("\n‚úÖ EXPECTED BEHAVIOR:")
    print("  - All malicious filenames posted to Discord (webhook accepts anything)")
    print("  - Bot REJECTS all via _validate_stats_filename()")
    print("  - Bot logs show 'Invalid filename format' for each")
    print("  - Zero malicious files downloaded")
    print("  - No file system access outside gamestats directory")
    print()

    # Success criteria
    print("‚úÖ SUCCESS CRITERIA:")
    print("  [ ] All bot logs show 'Invalid filename format'")
    print("  [ ] Zero files in local_stats/ matching malicious patterns")
    print("  [ ] No unauthorized file system access")
    print("  [ ] Bot still responsive to valid filenames")
    print()

    return 0


if __name__ == "__main__":
    try:
        exit(main())
    except KeyboardInterrupt:
        print("\n\nAborted by user (Ctrl+C)")
        sys.exit(1)
