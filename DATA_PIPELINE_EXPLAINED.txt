================================================================================
ğŸ“Š ET:LEGACY STATS PIPELINE - "EXPLAIN LIKE I'M 5" VERSION
================================================================================

ğŸ® STAGE 1: NEW STATS FILE APPEARS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server creates: gamestats_2025-11-06_120000.txt                        â”‚
â”‚ Location: /home/et/.etlegacy/legacy/gamestats/                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â° SSH Monitor Detects It
                    (checks every 60 seconds for new files)
                                    â”‚
                                    â–¼


ğŸ“¥ STAGE 2: FILE DOWNLOAD (SSH Monitor)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SSH Monitor:                                                            â”‚
â”‚  âœ“ Sees new file on server                                             â”‚
â”‚  âœ“ Downloads to: ./local_stats/gamestats_2025-11-06_120000.txt         â”‚
â”‚  âœ“ Marks file as "downloaded" (so we don't download twice)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


ğŸ“– STAGE 3: PARSE THE FILE (C0RNP0RN3StatsParser)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parser reads the text file and extracts:                               â”‚
â”‚                                                                         â”‚
â”‚  From filename:                                                         â”‚
â”‚    ğŸ“… Date: 2025-11-06                                                  â”‚
â”‚    â° Time: 12:00:00                                                    â”‚
â”‚    ğŸ—ºï¸  Map: "goldrush"                                                  â”‚
â”‚                                                                         â”‚
â”‚  From file content:                                                     â”‚
â”‚    ğŸ‘¥ 8 players with all their stats (52 fields each)                   â”‚
â”‚       - kills, deaths, damage, accuracy, etc.                          â”‚
â”‚    ğŸ”« 45 weapon stats (9 fields each)                                   â”‚
â”‚       - per player, per weapon                                         â”‚
â”‚    ğŸ† Round winner, scores, objectives                                  â”‚
â”‚                                                                         â”‚
â”‚  Output: Python dictionary with ALL this data                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


âœ… STAGE 4: VALIDATION (7 Checks!)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Before saving, we check:                                               â”‚
â”‚                                                                         â”‚
â”‚  1ï¸âƒ£ Player count matches? (parsed 8 = database has 8?)                 â”‚
â”‚  2ï¸âƒ£ Weapon count matches? (parsed 45 = database has 45?)               â”‚
â”‚  3ï¸âƒ£ Total kills add up? (all players' kills = database total?)         â”‚
â”‚  4ï¸âƒ£ Total deaths add up?                                                â”‚
â”‚  5ï¸âƒ£ Kills + deaths balance? (someone's kill = someone's death)         â”‚
â”‚  6ï¸âƒ£ Damage dealt + received balance?                                    â”‚
â”‚  7ï¸âƒ£ Weapon stats match player stats?                                    â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ If any check fails by >5: LOG WARNING (but still save!)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


ğŸ’¾ STAGE 5: SAVE TO DATABASE (PostgreSQL)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transaction starts (all-or-nothing save):                              â”‚
â”‚                                                                         â”‚
â”‚  Step 1: Calculate gaming_session_id                                   â”‚
â”‚    â”œâ”€ Check last round's time                                          â”‚
â”‚    â”œâ”€ If gap > 60 minutes: new session!                                â”‚
â”‚    â””â”€ Assign session ID (1, 2, 3, etc.)                                â”‚
â”‚                                                                         â”‚
â”‚  Step 2: INSERT into "rounds" table                                    â”‚
â”‚    â”œâ”€ Round ID (auto-generated)                                        â”‚
â”‚    â”œâ”€ Date, time, map, winner                                          â”‚
â”‚    â””â”€ Gaming session ID                                                â”‚
â”‚         â†’ rounds table has 1 new row                                   â”‚
â”‚                                                                         â”‚
â”‚  Step 3: INSERT into "player_comprehensive_stats" table                â”‚
â”‚    â”œâ”€ For each of 8 players:                                           â”‚
â”‚    â”‚   â”œâ”€ Round ID (links to round above)                              â”‚
â”‚    â”‚   â”œâ”€ Player GUID, name, team                                      â”‚
â”‚    â”‚   â””â”€ ALL 52 stats fields                                          â”‚
â”‚    â””â”€ player_comprehensive_stats table has 8 new rows                  â”‚
â”‚                                                                         â”‚
â”‚  Step 4: INSERT into "weapon_comprehensive_stats" table                â”‚
â”‚    â”œâ”€ For each of 45 weapon stats:                                     â”‚
â”‚    â”‚   â”œâ”€ Round ID (links to round)                                    â”‚
â”‚    â”‚   â”œâ”€ Player GUID, weapon name                                     â”‚
â”‚    â”‚   â””â”€ 9 weapon fields (kills, deaths, hits, etc.)                  â”‚
â”‚    â””â”€ weapon_comprehensive_stats table has 45 new rows                 â”‚
â”‚                                                                         â”‚
â”‚  Step 5: Mark file as "processed"                                      â”‚
â”‚    â””â”€ processed_files table: filename, success=true, timestamp         â”‚
â”‚                                                                         â”‚
â”‚  Transaction commits! âœ…                                                â”‚
â”‚  (If ANY step fails, ALL steps rollback - keeps DB clean!)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


ğŸ“ STAGE 6: LOGGING (for debugging later)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write to log files:                                                    â”‚
â”‚                                                                         â”‚
â”‚  logs/database.log:                                                    â”‚
â”‚    "âœ“ Imported gamestats_2025-11-06_120000.txt:                        â”‚
â”‚     8 players, 45 weapons [2.15s]"                                     â”‚
â”‚                                                                         â”‚
â”‚  logs/bot.log:                                                         â”‚
â”‚    "âœ“ File processed successfully"                                     â”‚
â”‚                                                                         â”‚
â”‚  (If error: also write to logs/errors.log with stack trace)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


ğŸ® STAGE 7: VOICE CHANNEL DETECTION (Optional - if automation enabled)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Voice Monitor watches:                                                 â”‚
â”‚  ğŸ‘‚ Are 6+ people in gaming voice channel?                             â”‚
â”‚     â”œâ”€ YES â†’ Gaming session started!                                   â”‚
â”‚     â””â”€ NO â†’ Wait...                                                    â”‚
â”‚                                                                         â”‚
â”‚  â° Did people leave voice channel?                                     â”‚
â”‚     â”œâ”€ Less than 2 people for 3 minutes?                               â”‚
â”‚     â””â”€ YES â†’ Session ended! Trigger !last_session                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼


ğŸ“¢ STAGE 8: POST TO DISCORD (Automatic or Manual)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Two ways to post stats:                                                â”‚
â”‚                                                                         â”‚
â”‚  A) AUTOMATIC (Voice Monitor):                                         â”‚
â”‚     When session ends â†’ Auto-post !last_session to Discord             â”‚
â”‚                                                                         â”‚
â”‚  B) MANUAL (User command):                                             â”‚
â”‚     User types: !last_session                                          â”‚
â”‚                                                                         â”‚
â”‚  Either way, bot fetches from database and creates:                    â”‚
â”‚    ğŸ“Š 6 embed cards (overview, combat, weapons, etc.)                   â”‚
â”‚    ğŸ“ˆ 2 graph images (performance, efficiency)                          â”‚
â”‚    âœ‰ï¸ Sends to #stats channel                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                               
                          âœ… DONE! Stats are live!


================================================================================
ğŸ“ WHERE DATA LIVES AT EACH STAGE
================================================================================

1ï¸âƒ£ Game Server         â†’ /home/et/.etlegacy/legacy/gamestats/*.txt
2ï¸âƒ£ Bot Local Storage   â†’ ./local_stats/*.txt (copy)
3ï¸âƒ£ Parser Memory       â†’ Python dict (temporary)
4ï¸âƒ£ PostgreSQL Database â†’ PERMANENT storage:
   â”œâ”€ rounds table (1 row per round)
   â”œâ”€ player_comprehensive_stats (8 rows per round)
   â”œâ”€ weapon_comprehensive_stats (45 rows per round)
   â””â”€ processed_files (1 row per file)
5ï¸âƒ£ Log Files          â†’ ./logs/*.log (for debugging)
6ï¸âƒ£ Discord Messages   â†’ #stats channel (pretty display)


================================================================================
â±ï¸ TIMING
================================================================================

From file creation to Discord post:

  Server creates file:      0 seconds
       â†“ (SSH monitor checks every 60s)
  Download file:           +5 seconds
  Parse file:              +0.5 seconds
  Validate data:           +0.2 seconds
  Save to database:        +2 seconds
  Post to Discord:         +3 seconds (if automatic)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL:                   ~10-70 seconds (depends on monitor timing)


================================================================================
ğŸ›¡ï¸ ERROR HANDLING AT EACH STAGE
================================================================================

Stage 1 (Detection):  âŒ Can't connect to server â†’ Retry next check
Stage 2 (Download):   âŒ Download fails â†’ Skip file, retry next time
Stage 3 (Parse):      âŒ Invalid file format â†’ Mark as failed, skip
Stage 4 (Validate):   âš ï¸ Data mismatch â†’ Log warning, still save
Stage 5 (Database):   âŒ DB error â†’ Rollback, mark as failed
Stage 6 (Logging):    âŒ Can't write log â†’ Continue anyway
Stage 7 (Voice):      âŒ Discord error â†’ Continue anyway
Stage 8 (Discord):    âŒ Post fails â†’ User can retry manually


================================================================================
ğŸ—„ï¸ DATABASE SCHEMA (WHERE EACH FIELD GOES)
================================================================================

ğŸ“‹ rounds table:
  - round_id (primary key)
  - round_date, round_time
  - map_name, winner
  - gaming_session_id â† Links rounds into sessions!
  - axis_score, allies_score
  - filename (which .txt file)

ğŸ“‹ player_comprehensive_stats table:
  - round_id (foreign key â†’ rounds)
  - player_guid (unique player ID)
  - player_name, team
  - kills, deaths, damage_given, damage_received
  - accuracy, headshots, revives
  - time_played, objectives
  - ... ALL 52 fields!

ğŸ“‹ weapon_comprehensive_stats table:
  - round_id (foreign key â†’ rounds)
  - player_guid
  - weapon_name (mp40, thompson, etc.)
  - kills, deaths, shots, hits
  - headshots, accuracy
  - ... 9 weapon fields

ğŸ“‹ processed_files table:
  - filename
  - processed_at (timestamp)
  - success (true/false)
  - error_message (if failed)


================================================================================
ğŸ¯ KEY INSIGHTS
================================================================================

âœ… Each file creates exactly:
   - 1 round
   - 8 player stats (one per player)
   - 45 weapon stats (multiple per player)
   - 1 processed_files entry

âœ… Gaming sessions group rounds together:
   - Session 1: Rounds 1-10 (played continuously)
   - 60+ minute gap
   - Session 2: Rounds 11-18 (new gaming night)

âœ… Database is the source of truth:
   - Original .txt files can be deleted
   - Everything is in PostgreSQL
   - Can rebuild Discord posts anytime from DB

âœ… Logging tracks everything:
   - What went wrong
   - How long things took
   - Who did what

