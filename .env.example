# ============================================
# ET:LEGACY DISCORD BOT - COMPLETE CONFIGURATION
# ============================================
# Copy this file to .env and fill in your values
# cp .env.example .env

# ============================================
# REQUIRED - Discord Bot Configuration
# ============================================

# Your Discord bot token from https://discord.com/developers/applications
# NEVER share this token or commit it to git!
DISCORD_BOT_TOKEN=YOUR_DISCORD_BOT_TOKEN_HERE

# ============================================
# REQUIRED - PostgreSQL Database Configuration
# ============================================

# PostgreSQL connection settings
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DATABASE=etlegacy
POSTGRES_USER=etlegacy_user
POSTGRES_PASSWORD=your_secure_password_here

# Required for website/API session signing (docker-compose enforces this)
# Generate with: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
SESSION_SECRET=

# ============================================
# WEBSITE API PERFORMANCE / CACHING
# ============================================
# Redis-backed API cache (recommended in production)
CACHE_BACKEND=redis
REDIS_URL=redis://localhost:6379/0
CACHE_DEFAULT_TTL_SECONDS=120
CACHE_LIVE_TTL_SECONDS=15
CACHE_LEADERBOARD_TTL_SECONDS=300
# Max JSON response size (bytes) eligible for HTTP cache storage.
CACHE_MAX_BODY_BYTES=2097152
# Comma-separated write-path prefixes that trigger full cache namespace invalidation.
CACHE_INVALIDATE_ON_WRITE_PREFIXES=/api/stats,/api/sessions,/api/proximity,/api/monitoring

# HTTP rate limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_WINDOW_SECONDS=60
RATE_LIMIT_REQUESTS_PER_WINDOW=180
RATE_LIMIT_HEAVY_REQUESTS_PER_WINDOW=45
RATE_LIMIT_CLEANUP_INTERVAL_SECONDS=60
RATE_LIMIT_MAX_TRACKED_KEYS=50000

# Prometheus metrics endpoint (/metrics)
PROMETHEUS_ENABLED=true
# Startup timeout (seconds) for non-critical Greatshot worker bootstrap.
GREATSHOT_STARTUP_TIMEOUT_SECONDS=20
# Enable/disable Greatshot worker startup at web boot.
GREATSHOT_STARTUP_ENABLED=true

# Bot startup behavior:
# - false: normal Discord login required
# - true: validate config/startup path only, skip Discord connection
BOT_STARTUP_VALIDATE_ONLY=false

# Optional host-bind overrides for docker-compose (defaults are localhost-only)
# POSTGRES_BIND_ADDRESS=127.0.0.1
# REDIS_BIND_ADDRESS=127.0.0.1
# API_BIND_ADDRESS=127.0.0.1
# WEBSITE_BIND_ADDRESS=127.0.0.1
# PROMETHEUS_BIND_ADDRESS=127.0.0.1
# GRAFANA_BIND_ADDRESS=127.0.0.1

# Required only when enabling docker-compose --profile observability (Grafana)
GRAFANA_ADMIN_USER=
GRAFANA_ADMIN_PASSWORD=

# Optional: Connection pool settings (default values shown)
# POSTGRES_MIN_POOL=10
# POSTGRES_MAX_POOL=30

# ============================================
# REQUIRED - Discord Channel IDs
# ============================================
# To get channel IDs:
# 1. Enable Developer Mode: Discord → Settings → Advanced → Developer Mode
# 2. Right-click channel → Copy ID
# 3. Paste the numeric ID below

# Voice channels to monitor for session detection (comma-separated)
# Example: GAMING_VOICE_CHANNELS=123456789012345678,987654321098765432
GAMING_VOICE_CHANNELS=

# Text channels where bot commands will work (comma-separated)
# Example: BOT_COMMAND_CHANNELS=123456789012345678,987654321098765432
BOT_COMMAND_CHANNELS=

# Channel where bot posts match summaries
STATS_CHANNEL_ID=

# Channel where bot posts admin alerts and errors
# Also used for admin-only commands (rcon, map_add, server control, etc.)
# Production: 822036093775249438
# Bot-dev: 1424620551300710511 or 1424620499975274496
ADMIN_CHANNEL_ID=

# Bot Owner (Discord User ID - highest permission tier)
# This is YOUR Discord user ID - enables owner-only commands
# Find it by: right-click your name in Discord → Copy User ID
OWNER_USER_ID=231165917604741121

# ============================================
# OPTIONAL - Automation Settings
# ============================================

# Enable automatic stats file processing
# Set to 'true' to enable, 'false' to disable
AUTOMATION_ENABLED=true

# File Processing Lookback Window
# When bot restarts, process files within this many hours BEFORE startup
# Default: 168 hours (7 days) - prevents importing ancient files while
# recovering recent files created during bot downtime
# Increase if bot is frequently offline for extended periods
STARTUP_LOOKBACK_HOURS=168

# Optional Settings
LOG_LEVEL=INFO

# ============================================
# OPTIONAL - SSH Monitoring (for auto-download from game server)
# ============================================

# Enable SSH monitoring to auto-download stats files from game server
# Set to 'false' if you're manually copying files
SSH_ENABLED=false

# Game server SSH connection details
SSH_HOST=your.gameserver.com
SSH_PORT=22
SSH_USER=etlegacy

# Path to your SSH private key
# Linux/Mac: /home/youruser/.ssh/etlegacy_bot
# Windows: C:/Users/YourName/.ssh/etlegacy_bot
SSH_KEY_PATH=

# Path to stats directory on game server
# Usually: /home/et/.etlegacy/legacy/gamestats
REMOTE_STATS_PATH=/home/et/.etlegacy/legacy/gamestats

# How often to check for new files (in seconds)
SSH_CHECK_INTERVAL=60

# SECURITY: SSH Host Key Verification (always enforced)
# The bot always requires known_hosts verification (prevents MITM attacks).
# Before enabling, add your server's key: ssh-keyscan -H your.server.com >> ~/.ssh/known_hosts
SSH_STRICT_HOST_KEY=true
# Legacy compatibility flag; insecure host-key auto-accept mode is disabled.
SSH_ALLOW_INSECURE_HOST_KEY=false

# On bot startup, only process files from last X hours
# Prevents re-processing thousands of old files
SSH_STARTUP_LOOKBACK_HOURS=24

# Optional: only run SSH polling when monitored voice channels are active.
SSH_VOICE_CONDITIONAL=true

# Optional grace window (minutes) after voice empties before SSH polling stops.
SSH_GRACE_PERIOD_MINUTES=10

# ============================================
# OPTIONAL - Webhook Trigger Notifications
# ============================================
# Alternative to SSH polling: VPS sends webhook to Discord when new file created
# Bot monitors Discord channel and processes files immediately (faster than SSH polling)
#
# ⚠️ SECURITY CRITICAL: If enabled, MUST configure whitelist!

# Control channel where VPS webhook posts notifications
# This should be a PRIVATE admin/control channel, NOT the public stats channel
# Get ID: Right-click channel → Copy ID (Developer Mode required in Discord settings)
WEBHOOK_TRIGGER_CHANNEL_ID=0

# Webhook ID whitelist (REQUIRED if webhook trigger enabled)
# Only webhooks with these IDs can trigger file processing
# Get webhook ID from Discord webhook URL: https://discord.com/api/webhooks/WEBHOOK_ID/TOKEN
# Format: Comma-separated list of webhook IDs (no spaces)
# Example: WEBHOOK_TRIGGER_WHITELIST=1234567890123456789,9876543210987654321
WEBHOOK_TRIGGER_WHITELIST=

# Expected webhook username (RECOMMENDED for additional security)
# Webhook messages must come from this username
# Default: ET:Legacy Stats (matches VPS script default)
WEBHOOK_TRIGGER_USERNAME=ET:Legacy Stats

# ============================================
# SECURITY NOTES - Webhook Triggers:
# ============================================
# 1. Webhook trigger channel should be PRIVATE (only bot and webhook can access)
# 2. WEBHOOK_TRIGGER_WHITELIST is MANDATORY if webhook trigger enabled
#    - Bot will REFUSE to start if channel configured but whitelist empty
#    - This prevents unauthorized webhooks from triggering malicious downloads
# 3. Never share webhook URLs publicly (they contain secret tokens)
# 4. Bot validates all filenames to prevent path traversal attacks
# 5. Rate limiting: Max 5 webhook triggers per minute (prevents DoS)
# 6. All webhook security events are logged to logs/bot.log
# ============================================

# ============================================
# OPTIONAL - Lua Stats Webhook (Real-Time Notifications)
# ============================================
# The game server can run a Lua script that POSTs round metadata directly
# to Discord when rounds complete. This provides:
# - Instant notification (vs 60s SSH polling)
# - Accurate timing on surrenders (fixes the surrender duration bug)
# - Pause tracking (new capability)
#
# Setup:
# 1. Copy vps_scripts/stats_discord_webhook.lua to game server's luascripts/
# 2. Create a webhook in the same WEBHOOK_TRIGGER_CHANNEL_ID channel
# 3. Add the webhook's ID to WEBHOOK_TRIGGER_WHITELIST
# 4. Configure the webhook URL in the Lua script
#
# The Lua script sends "STATS_READY" with embedded metadata, then the bot
# fetches the actual stats file via SSH. This maintains security (outbound-only)
# while providing real-time notifications.
#
# Note: Both the existing Python webhook notifier AND the Lua webhook can
# coexist - they use the same channel and whitelist. The bot handles both formats.
# ============================================

# ============================================
# OPTIONAL - Timing Debug (Lua Webhook Validation)
# ============================================
# Posts debug embeds comparing stats file timing vs Lua webhook timing.
# Useful for validating that surrender timing fixes and pause tracking work correctly.

# Enable timing debug posts to dev channel
TIMING_DEBUG_ENABLED=true

# Channel ID for timing debug posts (developer/testing channel)
# Default: 1424620499975274496 (our dev channel)
TIMING_DEBUG_CHANNEL_ID=1424620499975274496

# Channel ID for timing comparison posts (Lua vs Stats file analysis)
# This is a separate dev feature for comparing timing data sources
# Set to a dev channel where comparison embeds will be posted
DEV_TIMING_CHANNEL_ID=0

# Enable/disable timing comparison posts (default: true)
# When enabled, posts comparison embeds after each round showing:
# - Stats file timing vs Lua webhook timing
# - Per-player times with correction factors
TIMING_COMPARISON_ENABLED=true

# ============================================
# OPTIONAL - File Paths
# ============================================

# Local directory where downloaded stats files are stored
# Bot will create this directory if it doesn't exist
# Use relative path (./local_stats) or absolute path
LOCAL_STATS_PATH=./local_stats

# Directory for processed/backup files
# BACKUP_DIRECTORY=./processed_stats

# SQLite database for metrics (not main stats)
METRICS_DB_PATH=bot/logs/metrics/metrics.db

# ============================================
# OPTIONAL - Session Detection
# ============================================

# Number of players needed in voice channels to start a session
SESSION_START_THRESHOLD=6

# Minimum players before session ends
SESSION_END_THRESHOLD=2

# Wait time before ending session (in seconds)
# Allows for bathroom breaks without ending session
SESSION_END_DELAY=300

# Minutes between rounds that define a new gaming session
# If rounds are more than this apart, they're separate sessions
# Default: 60 minutes
SESSION_GAP_MINUTES=60

# ============================================
# OPTIONAL - Round Matching & Monitoring Timing
# ============================================
# These values work together - ensure they're consistent!

# Maximum time gap (minutes) for R1-R2 matching
# R2 files contain cumulative stats; parser finds R1 from within this window
# MUST be less than SESSION_GAP_MINUTES to avoid cross-session matching
# Default: 45 minutes (was hardcoded as 30)
ROUND_MATCH_WINDOW_MINUTES=45

# How long to keep monitoring after voice channels empty (minutes)
# Prevents missing late-arriving stats files
# Should match ROUND_MATCH_WINDOW_MINUTES for consistency
# Default: 45 minutes
MONITORING_GRACE_PERIOD_MINUTES=45

# ============================================
# OPTIONAL - Server Control (Advanced)
# ============================================
# These settings enable server control commands (!server_start, !map_change, etc.)
# Requires additional setup on game server

# Enable RCON (remote console) commands
RCON_ENABLED=false

# RCON connection (usually same as SSH_HOST)
RCON_HOST=localhost
RCON_PORT=27960
RCON_PASSWORD=

# ============================================
# OPTIONAL - Advanced Settings
# ============================================

# Database type: 'postgresql' (recommended) or 'sqlite' (dev only)
# DATABASE_TYPE=postgresql

# SQLite database path (only used if DATABASE_TYPE=sqlite)
# SQLITE_DB_PATH=bot/etlegacy_production.db

# Stats directory for manual parsing
# STATS_DIRECTORY=local_stats

# Discord guild ID (usually auto-detected)
# DISCORD_GUILD_ID=

# ============================================
# OPTIONAL - Date-based Availability + Notifications
# ============================================

# Enable bot-side multi-channel availability scheduler
AVAILABILITY_MULTICHANNEL_ENABLED=true

# Daily reminder scheduler time (24h, availability timezone)
AVAILABILITY_DAILY_REMINDER_TIME=16:00

# Session-ready threshold (LOOKING count)
AVAILABILITY_SESSION_READY_THRESHOLD=6

# Link token TTL (minutes) for !avail_link telegram|signal
AVAILABILITY_LINK_TOKEN_TTL_MINUTES=30
# Minimum seconds between website link-token generations per user+channel
AVAILABILITY_LINK_TOKEN_MIN_INTERVAL_SECONDS=30

# Advisory lock key for singleton scheduler
AVAILABILITY_SCHEDULER_LOCK_KEY=875211

# Promotion campaign scheduler
# Default schedule is 20:45 CET reminder + 21:00 CET start.
AVAILABILITY_PROMOTION_ENABLED=true
AVAILABILITY_PROMOTION_TIMEZONE=Europe/Ljubljana
AVAILABILITY_PROMOTION_REMINDER_TIME=20:45
AVAILABILITY_PROMOTION_START_TIME=21:00
AVAILABILITY_PROMOTION_FOLLOWUP_CHANNEL_ID=0
AVAILABILITY_PROMOTION_VOICE_CHECK_ENABLED=true
AVAILABILITY_PROMOTION_SERVER_CHECK_ENABLED=true
AVAILABILITY_PROMOTION_JOB_MAX_ATTEMPTS=5
# Planning room thread integration (optional website-side Discord API call)
AVAILABILITY_PLANNING_DISCORD_CREATE_THREAD=false
AVAILABILITY_PLANNING_THREAD_PARENT_CHANNEL_ID=
# Optional dedicated token for planning-room thread creation
AVAILABILITY_PLANNING_DISCORD_BOT_TOKEN=

# Discord delivery
AVAILABILITY_DISCORD_DM_ENABLED=true
AVAILABILITY_DISCORD_CHANNEL_ANNOUNCE_ENABLED=false
AVAILABILITY_DISCORD_ANNOUNCE_CHANNEL_ID=0

# Telegram connector (feature-flagged)
AVAILABILITY_TELEGRAM_ENABLED=false
AVAILABILITY_TELEGRAM_BOT_TOKEN=
AVAILABILITY_TELEGRAM_API_BASE_URL=https://api.telegram.org
AVAILABILITY_TELEGRAM_MIN_INTERVAL_SECONDS=0.25
AVAILABILITY_TELEGRAM_MAX_RETRIES=3
AVAILABILITY_TELEGRAM_REQUEST_TIMEOUT_SECONDS=15

# Signal connector (feature-flagged)
AVAILABILITY_SIGNAL_ENABLED=false
AVAILABILITY_SIGNAL_MODE=cli
AVAILABILITY_SIGNAL_CLI_PATH=signal-cli
AVAILABILITY_SIGNAL_SENDER=
AVAILABILITY_SIGNAL_DAEMON_URL=http://127.0.0.1:8080
AVAILABILITY_SIGNAL_MIN_INTERVAL_SECONDS=0.25
AVAILABILITY_SIGNAL_MAX_RETRIES=2
AVAILABILITY_SIGNAL_REQUEST_TIMEOUT_SECONDS=20

# ============================================
# QUICK SETUP CHECKLIST
# ============================================
# ✅ 1. Copy this file: cp .env.example .env
# ✅ 2. Fill in DISCORD_BOT_TOKEN (from Discord Developer Portal)
# ✅ 3. Fill in POSTGRES_* settings (after creating database)
# ✅ 4. Fill in *_CHANNEL_ID settings (right-click channels in Discord)
# ✅ 5. (Optional) Fill in SSH_* settings for auto-monitoring
# ✅ 6. Save file and start bot: python bot/ultimate_bot.py
#
# For detailed setup instructions, see README_PRODUCTION_READY.md
# ============================================

# ============================================
# OPTIONAL - Date-based Availability + Notifications
# ============================================
# Enable bot-side multi-channel availability scheduler
AVAILABILITY_MULTICHANNEL_ENABLED=true
# Daily reminder scheduler time (24h, availability timezone)
AVAILABILITY_DAILY_REMINDER_TIME=16:00
# Session-ready threshold (LOOKING count)
AVAILABILITY_SESSION_READY_THRESHOLD=6
# Advisory lock key for singleton scheduler
AVAILABILITY_SCHEDULER_LOCK_KEY=875211
# Discord delivery
AVAILABILITY_DISCORD_DM_ENABLED=true
AVAILABILITY_DISCORD_CHANNEL_ANNOUNCE_ENABLED=false
AVAILABILITY_DISCORD_ANNOUNCE_CHANNEL_ID=0
# Telegram connector (feature-flagged)
AVAILABILITY_TELEGRAM_ENABLED=false
AVAILABILITY_TELEGRAM_BOT_TOKEN=
# Signal connector (feature-flagged)
AVAILABILITY_SIGNAL_ENABLED=false
AVAILABILITY_SIGNAL_MODE=cli
AVAILABILITY_SIGNAL_CLI_PATH=signal-cli
AVAILABILITY_SIGNAL_SENDER=
AVAILABILITY_SIGNAL_DAEMON_URL=http://127.0.0.1:8080
