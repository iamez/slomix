# ============================================
# ET:LEGACY DISCORD BOT - COMPLETE CONFIGURATION
# ============================================
# Copy this file to .env and fill in your values
# cp .env.example .env

# ============================================
# REQUIRED - Discord Bot Configuration
# ============================================

# Your Discord bot token from https://discord.com/developers/applications
# NEVER share this token or commit it to git!
DISCORD_BOT_TOKEN=YOUR_DISCORD_BOT_TOKEN_HERE

# ============================================
# REQUIRED - PostgreSQL Database Configuration
# ============================================

# PostgreSQL connection settings
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DATABASE=etlegacy
POSTGRES_USER=etlegacy_user
POSTGRES_PASSWORD=your_secure_password_here

# Optional: Connection pool settings (default values shown)
# POSTGRES_MIN_POOL=10
# POSTGRES_MAX_POOL=30

# ============================================
# REQUIRED - Discord Channel IDs
# ============================================
# To get channel IDs:
# 1. Enable Developer Mode: Discord → Settings → Advanced → Developer Mode
# 2. Right-click channel → Copy ID
# 3. Paste the numeric ID below

# Voice channels to monitor for session detection (comma-separated)
# Example: GAMING_VOICE_CHANNELS=123456789012345678,987654321098765432
GAMING_VOICE_CHANNELS=

# Text channels where bot commands will work (comma-separated)
# Example: BOT_COMMAND_CHANNELS=123456789012345678,987654321098765432
BOT_COMMAND_CHANNELS=

# Channel where bot posts match summaries
STATS_CHANNEL_ID=

# Channel where bot posts admin alerts and errors
ADMIN_CHANNEL_ID=

# Bot Owner (Discord User ID - highest permission tier)
# This is YOUR Discord user ID - enables owner-only commands
# Find it by: right-click your name in Discord → Copy User ID
OWNER_USER_ID=231165917604741121

# ============================================
# OPTIONAL - Automation Settings
# ============================================

# Enable automatic stats file processing
# Set to 'true' to enable, 'false' to disable
AUTOMATION_ENABLED=true

# File Processing Lookback Window
# When bot restarts, process files within this many hours BEFORE startup
# Default: 168 hours (7 days) - prevents importing ancient files while
# recovering recent files created during bot downtime
# Increase if bot is frequently offline for extended periods
STARTUP_LOOKBACK_HOURS=168

# SSH Monitoring Configuration (Optional - for auto-download from VPS)
SSH_ENABLED=false
SSH_HOST=your.vps.server
SSH_PORT=22
SSH_USER=et
SSH_KEY_PATH=~/.ssh/etlegacy_bot
REMOTE_STATS_PATH=/home/et/.etlegacy/legacy/gamestats
SSH_CHECK_INTERVAL=60
SSH_STARTUP_LOOKBACK_HOURS=24
SSH_VOICE_CONDITIONAL=true
SSH_GRACE_PERIOD_MINUTES=10

# Voice Channel Monitoring (for voice-conditional SSH checks)
GAMING_VOICE_CHANNELS=

# Discord Channel IDs
STATS_CHANNEL_ID=0
ADMIN_CHANNEL_ID=0

# Metrics Configuration
METRICS_DB_PATH=bot/data/metrics.db

# Optional Settings
LOG_LEVEL=INFO

# ============================================
# OPTIONAL - SSH Monitoring (for auto-download from game server)
# ============================================

# Enable SSH monitoring to auto-download stats files from game server
# Set to 'false' if you're manually copying files
SSH_ENABLED=false

# Game server SSH connection details
SSH_HOST=your.gameserver.com
SSH_PORT=22
SSH_USER=etlegacy

# Path to your SSH private key
# Linux/Mac: /home/youruser/.ssh/etlegacy_bot
# Windows: C:/Users/YourName/.ssh/etlegacy_bot
SSH_KEY_PATH=

# Path to stats directory on game server
# Usually: /home/et/.etlegacy/legacy/gamestats
REMOTE_STATS_PATH=/home/et/.etlegacy/legacy/gamestats

# How often to check for new files (in seconds)
SSH_CHECK_INTERVAL=60

# SECURITY: SSH Host Key Verification (RECOMMENDED for production)
# Set to 'true' to require known_hosts verification (prevents MITM attacks)
# Set to 'false' for development convenience (auto-accepts new hosts)
# Before enabling, add your server's key: ssh-keyscan -H your.server.com >> ~/.ssh/known_hosts
SSH_STRICT_HOST_KEY=false

# On bot startup, only process files from last X hours
# Prevents re-processing thousands of old files
SSH_STARTUP_LOOKBACK_HOURS=24

# ============================================
# OPTIONAL - Webhook Trigger Notifications
# ============================================
# Alternative to SSH polling: VPS sends webhook to Discord when new file created
# Bot monitors Discord channel and processes files immediately (faster than SSH polling)
#
# ⚠️ SECURITY CRITICAL: If enabled, MUST configure whitelist!

# Control channel where VPS webhook posts notifications
# This should be a PRIVATE admin/control channel, NOT the public stats channel
# Get ID: Right-click channel → Copy ID (Developer Mode required in Discord settings)
WEBHOOK_TRIGGER_CHANNEL_ID=0

# Webhook ID whitelist (REQUIRED if webhook trigger enabled)
# Only webhooks with these IDs can trigger file processing
# Get webhook ID from Discord webhook URL: https://discord.com/api/webhooks/WEBHOOK_ID/TOKEN
# Format: Comma-separated list of webhook IDs (no spaces)
# Example: WEBHOOK_TRIGGER_WHITELIST=1234567890123456789,9876543210987654321
WEBHOOK_TRIGGER_WHITELIST=

# Expected webhook username (RECOMMENDED for additional security)
# Webhook messages must come from this username
# Default: ET:Legacy Stats (matches VPS script default)
WEBHOOK_TRIGGER_USERNAME=ET:Legacy Stats

# ============================================
# SECURITY NOTES - Webhook Triggers:
# ============================================
# 1. Webhook trigger channel should be PRIVATE (only bot and webhook can access)
# 2. WEBHOOK_TRIGGER_WHITELIST is MANDATORY if webhook trigger enabled
#    - Bot will REFUSE to start if channel configured but whitelist empty
#    - This prevents unauthorized webhooks from triggering malicious downloads
# 3. Never share webhook URLs publicly (they contain secret tokens)
# 4. Bot validates all filenames to prevent path traversal attacks
# 5. Rate limiting: Max 5 webhook triggers per minute (prevents DoS)
# 6. All webhook security events are logged to logs/bot.log
# ============================================

# ============================================
# OPTIONAL - Lua Stats Webhook (Real-Time Notifications)
# ============================================
# The game server can run a Lua script that POSTs round metadata directly
# to Discord when rounds complete. This provides:
# - Instant notification (vs 60s SSH polling)
# - Accurate timing on surrenders (fixes the surrender duration bug)
# - Pause tracking (new capability)
#
# Setup:
# 1. Copy vps_scripts/stats_discord_webhook.lua to game server's luascripts/
# 2. Create a webhook in the same WEBHOOK_TRIGGER_CHANNEL_ID channel
# 3. Add the webhook's ID to WEBHOOK_TRIGGER_WHITELIST
# 4. Configure the webhook URL in the Lua script
#
# The Lua script sends "STATS_READY" with embedded metadata, then the bot
# fetches the actual stats file via SSH. This maintains security (outbound-only)
# while providing real-time notifications.
#
# Note: Both the existing Python webhook notifier AND the Lua webhook can
# coexist - they use the same channel and whitelist. The bot handles both formats.
# ============================================

# ============================================
# OPTIONAL - File Paths
# ============================================

# Local directory where downloaded stats files are stored
# Bot will create this directory if it doesn't exist
# Use relative path (./local_stats) or absolute path
LOCAL_STATS_PATH=./local_stats

# Directory for processed/backup files
# BACKUP_DIRECTORY=./processed_stats

# SQLite database for metrics (not main stats)
METRICS_DB_PATH=bot/data/metrics.db

# ============================================
# OPTIONAL - Session Detection
# ============================================

# Number of players needed in voice channels to start a session
SESSION_START_THRESHOLD=6

# Minimum players before session ends
SESSION_END_THRESHOLD=2

# Wait time before ending session (in seconds)
# Allows for bathroom breaks without ending session
SESSION_END_DELAY=300

# Minutes between rounds that define a new gaming session
# If rounds are more than this apart, they're separate sessions
# Default: 60 minutes
SESSION_GAP_MINUTES=60

# ============================================
# OPTIONAL - Round Matching & Monitoring Timing
# ============================================
# These values work together - ensure they're consistent!

# Maximum time gap (minutes) for R1-R2 matching
# R2 files contain cumulative stats; parser finds R1 from within this window
# MUST be less than SESSION_GAP_MINUTES to avoid cross-session matching
# Default: 45 minutes (was hardcoded as 30)
ROUND_MATCH_WINDOW_MINUTES=45

# How long to keep monitoring after voice channels empty (minutes)
# Prevents missing late-arriving stats files
# Should match ROUND_MATCH_WINDOW_MINUTES for consistency
# Default: 45 minutes
MONITORING_GRACE_PERIOD_MINUTES=45

# ============================================
# OPTIONAL - Server Control (Advanced)
# ============================================
# These settings enable server control commands (!server_start, !map_change, etc.)
# Requires additional setup on game server

# Enable RCON (remote console) commands
RCON_ENABLED=false

# RCON connection (usually same as SSH_HOST)
RCON_HOST=localhost
RCON_PORT=27960
RCON_PASSWORD=

# ============================================
# OPTIONAL - Advanced Settings
# ============================================

# Database type: 'postgresql' (recommended) or 'sqlite' (dev only)
# DATABASE_TYPE=postgresql

# SQLite database path (only used if DATABASE_TYPE=sqlite)
# SQLITE_DB_PATH=bot/etlegacy_production.db

# Stats directory for manual parsing
# STATS_DIRECTORY=local_stats

# Discord guild ID (usually auto-detected)
# DISCORD_GUILD_ID=

# ============================================
# QUICK SETUP CHECKLIST
# ============================================
# ✅ 1. Copy this file: cp .env.example .env
# ✅ 2. Fill in DISCORD_BOT_TOKEN (from Discord Developer Portal)
# ✅ 3. Fill in POSTGRES_* settings (after creating database)
# ✅ 4. Fill in *_CHANNEL_ID settings (right-click channels in Discord)
# ✅ 5. (Optional) Fill in SSH_* settings for auto-monitoring
# ✅ 6. Save file and start bot: python bot/ultimate_bot.py
#
# For detailed setup instructions, see README_PRODUCTION_READY.md
# ============================================
