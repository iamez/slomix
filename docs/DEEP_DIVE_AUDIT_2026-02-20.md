# Deep Dive Audit - February 20, 2026

> **Generated by**: Claude Code agentic team (4 parallel research agents + synthesis)
> **Scope**: All issues from KNOWN_ISSUES.md, STATS_FORMULA_RESEARCH.md, VM_MIGRATION_REPORT, AUDIT_FINDINGS_SECURITY, AUDIT_FINDINGS_CODE_QUALITY
> **Method**: Code-level verification against every file referenced in prior docs
> **Status**: Research complete - no code changes made

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Stats Formula Bugs](#2-stats-formula-bugs)
   - [2.1 Headshot Percentage](#21-headshot-percentage)
   - [2.2 time_played_seconds](#22-time_played_seconds)
   - [2.3 FragPotential Divergence](#23-fragpotential-divergence)
   - [2.4 Damage Efficiency Divergence](#24-damage-efficiency-divergence)
   - [2.5 Survival Rate Divergence](#25-survival-rate-divergence)
   - [2.6 Denied Playtime Display](#26-denied-playtime-display)
3. [Website UI Bugs](#3-website-ui-bugs)
4. [Infrastructure & Security](#4-infrastructure--security)
5. [Data Pipeline & Proximity](#5-data-pipeline--proximity)
6. [Corrections to Prior Docs](#6-corrections-to-prior-docs)
7. [Prioritized Fix Plan](#7-prioritized-fix-plan)

---

## 1. Executive Summary

We investigated every issue raised in the recent docs. Here's what's real and what's not:

| Category | Issues Claimed | Confirmed Real | Already Fixed | Overclaimed/Wrong |
|----------|---------------|----------------|---------------|-------------------|
| Stats Formulas | 6 | 4 | 0 | 2 |
| Website UI | 9 | 3 | 4 | 2 |
| Security | 3 high | 0 high | 3 already fixed | 0 |
| Code Quality | 7 | 3 | 2 | 2 |
| Pipeline/Proximity | 4 | 1 | 3 | 0 |

**Bottom line**: The STATS_FORMULA_RESEARCH.md doc overclaimed some issues. The real bugs are:
- Headshot % has **mixed formulas** across the codebase (not universally wrong, but inconsistent)
- Website uses completely wrong formulas for FragPotential, Survival Rate, and Damage Efficiency
- `time_played_seconds` uses round duration for all players (correct for stopwatch, wrong for partial players)
- Most website UI bugs are already fixed
- Security posture is actually good (GitHub Actions SHA-pinned, Docker non-root, secrets scanning in place)

---

## 2. Stats Formula Bugs

### 2.1 Headshot Percentage

**Prior claim** (STATS_FORMULA_RESEARCH.md): "WRONG everywhere - uses headshot_kills / kills, should use headshot_hits / total_hits"

**Actual finding**: The formula is NOT universally wrong. It's **inconsistent across the codebase** - different files use different formulas, and there are legitimate bugs, but the "correct" formula depends on what you want to measure.

#### What exists in the database

| Column | Table | Source | Meaning |
|--------|-------|--------|---------|
| `headshot_kills` | player_comprehensive_stats | TAB[14] (`topshots[5]`) | Kills where final blow was to head |
| `headshots` | player_comprehensive_stats | SUM of weapon headshots | Total shots that hit head hitbox (any weapon) |
| `headshots` | weapon_comprehensive_stats | `aWeaponStats[j][3]` | Per-weapon shots that hit head hitbox |

#### Current formulas by location

| Location | File:Line | Formula | What It Computes |
|----------|-----------|---------|-----------------|
| StatsCalculator | `bot/stats/calculator.py:182` | `headshot_kills / kills * 100` | % of kills that were headshots |
| FragPotential | `bot/core/frag_potential.py:139` | `headshot_kills / kills * 100` | Same |
| Stats Cog | `bot/cogs/stats_cog.py:388` | `headshot_kills / kills * 100` (via StatsCalculator) | Same |
| **Session Embed** | `bot/services/session_embed_builder.py:223` | **`total_hs / hits * 100`** | Headshot HITS / total HITS |
| **Leaderboard Query** | `bot/cogs/leaderboard_cog.py:587` | **`headshot_kills / weapon_hits`** | Mixed: KILLS / HITS |
| **Leaderboard Display** | `bot/cogs/leaderboard_cog.py:824` | **`hs / hits * 100`** | Mixed: KILLS / HITS |
| **Session Graph** | `bot/services/session_graph_generator.py:504` | **`COALESCE(headshots, headshot_kills)`** | Falls back between HIT count and KILL count |
| Website Weapon HOF | `website/backend/routers/api.py:4096` | `weapon_headshots / weapon_kills * 100` | Per-weapon HS kill rate |
| Website Weapon Stats | `website/backend/routers/api.py:4292` | `weapon_headshots / weapon_kills * 100` | Same |

#### Bugs confirmed

**BUG HS-1**: Leaderboard headshot query and display (`leaderboard_cog.py:587,824`)
- **Query sorts by**: `headshot_kills / weapon_hits` (KILLS divided by HITS = mixed units)
- **Display shows**: `hs / hits * 100` (same mixed units)
- **Impact**: Leaderboard ranking is meaningless - divides kill count by hit count
- **Fix**: Either use `headshot_kills / kills` consistently, or `headshots / hits` consistently

**BUG HS-2**: Session graph headshot fallback (`session_graph_generator.py:504`)
- **Code**: `SUM(COALESCE(p.headshots, p.headshot_kills, 0)) as headshots`
- **Problem**: `headshots` = hit count, `headshot_kills` = kill count. COALESCE picks whichever is non-null first, so the meaning of the value changes depending on which column has data
- **Fix**: Pick one column explicitly. Use `p.headshot_kills` for kill-based, or `p.headshots` for hit-based

**BUG HS-3**: Session embed uses different formula than everything else (`session_embed_builder.py:223`)
- **Code**: `hs_rate = (total_hs / hits * 100)` where `total_hs` comes from weapon headshot HITS
- **This is actually headshot accuracy** (hits on head / total hits), which is arguably the BETTER formula
- **But**: Every other place uses headshot_kills / kills, making this display inconsistent

#### Recommendation

Standardize on TWO named stats:
1. **Headshot Accuracy** = `weapon_headshots / total_hits * 100` (aim quality - what % of hits land on heads)
2. **Headshot Kill Rate** = `headshot_kills / total_kills * 100` (lethality - what % of kills are headshots)

Pick one as the primary "HS%" display. The session embed's formula (HS-3) is actually the more meaningful one.

**Severity**: MEDIUM - Numbers are wrong but in a subtle way most users won't notice

---

### 2.2 time_played_seconds

**Prior claim** (STATS_FORMULA_RESEARCH.md): "Parser uses round duration for ALL players instead of per-player Lua TAB[22] value"

**Actual finding**: CONFIRMED, but with important context.

**Code** (`bot/community_stats_parser.py:989`):
```python
player['time_played_seconds'] = round_time_seconds  # Same for ALL players
```

The parser DOES extract per-player time from TAB[22] into `objective_stats['time_played_minutes']` (line 1182), but it's stored in `objective_stats`, not used for the main `time_played_seconds` field.

**Why this mostly works**: In stopwatch mode (the primary competitive mode), teams are locked and everyone plays the full round. So round duration IS correct for most players.

**When it fails**:
- Late joiners (joined mid-round)
- Players who disconnect
- Spec-to-team switches

**Cascading impact**:
- DPM calculation at line 998: uses shared round time
- FragPotential: `damage_given / time_alive_seconds * 60` - time_alive derived from shared time
- Survival Rate: `100 - (time_dead / time_played * 100)` - ratio skewed

**Fix** (one line in parser):
```python
# After extracting objective_stats (around line 1005):
lua_time_min = player.get('objective_stats', {}).get('time_played_minutes', 0)
if lua_time_min > 0:
    player['time_played_seconds'] = int(lua_time_min * 60)
```

**Severity**: LOW-MEDIUM - Only affects partial-round players; stopwatch mode (95% of games) is fine

---

### 2.3 FragPotential Divergence

**Prior claim**: Bot and website use completely different formulas.

**Actual finding**: CONFIRMED.

| System | File:Line | Formula | Meaning |
|--------|-----------|---------|---------|
| **Bot** | `bot/core/frag_potential.py:126` | `(damage_given / time_alive_seconds) * 60` | DPM while alive |
| **Website** | `website/backend/routers/api.py:4896-4897` | `(kills + assists * 0.5) / time_minutes * 10` | Scaled kill+assist rate |

The website's "FragPotential" is a completely different metric with arbitrary scaling (`* 10`). It's not DPM-based at all - it's kill-rate-based.

**Fix**: Website should use same formula as bot:
```python
time_alive_seconds = stats["time_played"] - (stats.get("time_dead_minutes", 0) * 60)
frag_potential = (stats["damage_given"] / max(1, time_alive_seconds)) * 60
```

**Severity**: HIGH - Same label, completely different numbers between bot and website

---

### 2.4 Damage Efficiency Divergence

**Prior claim**: Bot uses ratio, website uses percentage.

**Actual finding**: CONFIRMED.

| System | File:Line | Formula | Scale | Example (2000 dmg dealt, 1000 recv) |
|--------|-----------|---------|-------|--------------------------------------|
| **Bot** | `bot/core/frag_potential.py:134` | `dmg_given / dmg_received` | 0 to infinity | **2.0x** |
| **Website** | `website/backend/routers/api.py:4900-4903` | `dmg_given / (dmg_given + dmg_recv) * 100` | 0-100% | **66.7%** |

Both are valid metrics, but using the same label for different scales is confusing.

**Fix**: Standardize on one. The ratio form (bot) is more common in FPS communities. Website should match.

**Severity**: MEDIUM - Different scales but same concept; confusing for users who see both

---

### 2.5 Survival Rate Divergence

**Prior claim**: Bot uses actual time-based, website uses meaningless heuristic.

**Actual finding**: CONFIRMED. The website formula is genuinely broken.

| System | File:Line | Formula |
|--------|-----------|---------|
| **Bot** | `bot/services/session_graph_generator.py:598-605` | `100 - (time_dead_minutes / time_played_minutes * 100)` |
| **Website** | `website/backend/routers/api.py:4906-4909` | `min(100, (time_played / (deaths + 1)) / 60 * 10)` |

The website formula computes "average seconds alive per life, scaled arbitrarily to 0-100." The `/ 60 * 10` scaling has no statistical meaning. A player with 600s played and 5 deaths gets: `(600 / 6) / 60 * 10 = 16.7%`, which tells you nothing.

**Fix**: Use the bot's formula:
```python
survival_rate = 100 - (stats.get("time_dead_minutes", 0) / max(0.01, time_minutes) * 100)
```

**Severity**: HIGH - Website survival rate is genuinely meaningless

---

### 2.6 Denied Playtime Display

**Prior claim**: Percentage display is confusing.

**Actual finding**: The calculation is correct (`session_graph_generator.py:586-591`). The percentage is `denied_seconds / time_played_seconds * 100`.

This can theoretically exceed 100% for extremely lethal players (they deny more cumulative enemy time than their own playtime). The metric is valid, but the display could be more intuitive.

**Severity**: LOW - Working correctly, just a UX preference

---

## 3. Website UI Bugs

### Summary: Most Are Already Fixed

| Bug | Reported Status | Actual Status | Details |
|-----|----------------|---------------|---------|
| Sessions unclickable | Open | **FIXED** | `toggleSession()` properly exported and exposed on `window` at `sessions.js:2016` |
| Upload "Watch" broken | Open | **FIXED** | `openVideoPlayer()` exposed on `window` at `uploads.js:808` |
| Upload "Download" streams | Open | **BY DESIGN** | Videos use `Content-Disposition: inline` (`uploads.py:376`) for browser playback. Non-video files use `attachment`. This is correct. |
| Upload "Share" opens player | Open | **BY DESIGN** | Share navigates to detail page at `#/uploads/{id}`, which includes embedded player + metadata + copy link |
| Clickable cards broken | Open | **MOSTLY FIXED** | Session expansion works. Upload cards require button clicks (not card-level click). |
| Diagnostics :8000 fallback | Open | **FIXED** | No hardcoded `:8000` found in diagnostics.js |

### Remaining Real Issues

**UI-1: Availability Page Needs Verification**
- File: `website/js/availability.js`
- Status: Code exists with extensive rendering logic (STATUS_META at lines 19-65, day cards, queue display)
- **Concern**: May not be initialized from `app.js` router. Need to verify the route handler actually calls `loadAvailabilityView()`
- Severity: MEDIUM

**UI-2: Demo Upload Form Wiring**
- File: `website/js/greatshot.js`
- Status: Core functions (`navigateToGreatshotDemo`, `navigateToDemo`) are exposed on window (lines 981, 986)
- **Concern**: File upload form submit handler may not be wired. Needs browser testing.
- Severity: MEDIUM

**UI-3: Availability Page Design (UX, not bug)**
- The page displays data correctly but feels like a spreadsheet. The KNOWN_ISSUES doc has good improvement ideas (player names/avatars, progress rings, "Almost there!" urgency).
- Severity: LOW (cosmetic)

---

## 4. Infrastructure & Security

### Prior Claims vs Reality

The AUDIT_FINDINGS_SECURITY doc (Feb 19) raised 3 High severity issues. Here's what we found:

| Finding | Claimed | Actual Status |
|---------|---------|---------------|
| SEC-001: Unpinned GitHub Actions | High | **ALREADY FIXED** - All actions are SHA-pinned with tag comments (e.g., `actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4`) |
| SEC-002: Docker runs as root | High | **ALREADY FIXED** - `Dockerfile.api` has `USER app` (line 19), `Dockerfile.website` uses `nginx-unprivileged` image with USER 101 |
| SEC-003: Missing .secrets.baseline | High | **ALREADY FIXED** - File exists (5038 bytes, dated 2026-02-19), detect-secrets hook configured in `.pre-commit-config.yaml` |

**These were all fixed between when the audit ran (Feb 19) and now.** Good work.

### Other Security Findings

**SQL Injection**: GOOD - All queries use parameterized placeholders (`$1`, `$2`). `escape_like_pattern()` helper exists for LIKE queries.

**Hardcoded Credentials** (`config.json`, `backups/`):
- `config.json` contains DB password `etlegacy_secure_2025` in plaintext
- `backups/2025-11/bot_backup_20251117_235848/config.json` contains DB password + RCON password
- **HOWEVER**: Both are already in `.gitignore` and NOT tracked by git (`git ls-files` returns empty)
- **Risk**: Local-only exposure on this Samba share. Not in git history.
- **Recommendation**: Still worth cleaning up. Delete `backups/` contents, ensure `config.json` isn't needed (`.env` is the canonical source).

### Code Quality

| Finding | Status | Notes |
|---------|--------|-------|
| CQ-001: SQLite refs in docs | VALID | `POSTGRESQL_MIGRATION_INDEX.md`, `ADVANCED_TEAM_DETECTION.md` still mention SQLite |
| CQ-002: .env.example duplicates | **NOT FOUND** | Well-structured, 408 lines, no duplicates detected |
| CQ-003: Greatshot skill_rating | GRACEFUL | Code checks with `_OPTIONAL_STATS_COLUMNS` and handles missing column cleanly (`greatshot_crossref.py:60`) |
| CQ-004: Proximity reactions stub | VALID | Endpoint works but table `proximity_reaction_metric` doesn't exist in schema |
| CQ-005: Mixed dependency pinning | **NOT FOUND** | Both `requirements.txt` files use exact version pins |
| CQ-006: JS lint syntax-only | VALID | `scripts/lint-js.sh` only runs `node --check` |
| CQ-007: Dual changelogs | BY DESIGN | Root `CHANGELOG.md` = Release Please auto-generated; `docs/CHANGELOG.md` = canonical detailed notes |

### Git State

- **Current branch**: `wip/forgot-push`
- **Merge conflicts**: 5 files with unmerged paths (availability_poll_cog, test_availability_router, website routers __init__, availability.js, utils.js)
- **Untracked**: STATS_FORMULA_RESEARCH.md, VM_MIGRATION_REPORT_2026-02-20.md
- **Note**: `feat/availability-multichannel-notifications` branch is way ahead of `main` (as noted in VM migration report)

---

## 5. Data Pipeline & Proximity

### Parser & R2 Differential: All Correct

| Component | Status | Evidence |
|-----------|--------|---------|
| R2 detection | CORRECT | `community_stats_parser.py:412` checks filename for `-round-2.txt` |
| R1 matching | CORRECT | 30-minute window search in same-day directory (line 507) |
| R2 differential | CORRECT | 26 R2-only fields in `R2_ONLY_FIELDS` dict (lines 45-71) are used directly; cumulative fields properly subtracted |
| time_played in R2 | CORRECT | Subtracted: `r2_time - r1_time` (lines 735-738) |

### Proximity System

| Component | Status | Details |
|-----------|--------|---------|
| Spawn reaction time fix | VERIFIED | `proximity_tracker.lua:1947-1950` has `gamestate == 0` guard; line 757 has `spawn_time >= 0` filter |
| `/api/proximity/reactions` | STUB | Endpoint fully written (`api.py:7314-7363`) but returns `{"status":"prototype","ready":false}` because `proximity_reaction_metric` table doesn't exist |
| Other proximity endpoints | WORKING | `/api/proximity/scopes` (7 sessions), `/api/proximity/summary` (9129 engagements, 51 rounds) all return data |

### Lua Webhook Handler

| Component | Status | Details |
|-----------|--------|---------|
| round_number=0 handling | FIXED | `ultimate_bot.py:1999` uses `round_number = 0` for match summaries (valid in stopwatch R2) |
| R2 webhook fix | FIXED | Guard changed from `round_number == 0 → invalid` to `round_number < 0 → invalid` |

### Database Schema

- **player_comprehensive_stats**: 52 columns (confirmed via schema count)
- **No `total_hits` column** - correctly derived at query time from `SUM(weapon_comprehensive_stats.hits)`
- **Schema is clean** - no missing columns for current functionality

### Signal Connector

- File: `bot/services/signal_connector.py`
- **Status**: Production-ready with CLI + daemon modes, retry logic, rate limiting, httpx async support
- Not a bug - fully implemented service

### Migration 005

- File: `website/migrations/005_date_based_availability.sql`
- Creates 5 tables: `availability_entries`, `availability_user_settings`, `availability_channel_links`, `availability_subscriptions`, `notifications_ledger`
- Supports multi-channel notifications (Discord/Telegram/Signal) with dedup ledger
- Clean migration, no issues

---

## 6. Corrections to Prior Docs

The existing `STATS_FORMULA_RESEARCH.md` doc contains several overclaims that should be corrected:

| Claim | Correction |
|-------|------------|
| "Headshot % is WRONG everywhere" | Not universal. `StatsCalculator`, `FragPotential`, `stats_cog` all use consistent `headshot_kills / kills`. The bugs are in `leaderboard_cog` (mixed units) and `session_graph_generator` (COALESCE fallback). |
| "Website HS rate at api.py:4096 is WRONG" | Actually correct for its context - it's per-weapon `weapon_headshots / weapon_kills`, which is valid for weapon-level stats. |
| "time_played should use TAB[22]" | True for partial players, but the comment in parser (line 983) explicitly notes "In stopwatch: everyone plays full round, so round_time_seconds is correct." The fix is still desirable but it's a conscious design choice, not a bug. |
| "GitHub Actions unpinned (High)" | Already SHA-pinned. |
| "Docker runs as root (High)" | Both Dockerfiles run non-root. |
| ".secrets.baseline missing (High)" | File exists. |
| ".env.example has duplicates" | Not found in current file. |
| "Mixed dependency pinning" | Both files use exact pins. |

---

## 7. Prioritized Fix Plan

### Priority 1: Website Formula Alignment (HIGH impact, moderate effort)

All in `website/backend/routers/api.py:4894-4909`:

| Metric | Current (Wrong) | Correct (Match Bot) |
|--------|-----------------|---------------------|
| FragPotential | `(kills + assists * 0.5) / time_min * 10` | `(damage_given / time_alive_sec) * 60` |
| Survival Rate | `min(100, avg_death_time / 60 * 10)` | `100 - (time_dead_min / time_played_min * 100)` |
| Damage Efficiency | `dmg_given / (dmg_given + dmg_recv) * 100` | `dmg_given / max(1, dmg_recv)` (ratio) |

**Files to change**: `website/backend/routers/api.py` (3 formulas in one function)
**Risk**: Low - only affects website display, not stored data
**Effort**: 30 minutes

### Priority 2: Headshot Leaderboard Fix (MEDIUM impact, small effort)

**File**: `bot/cogs/leaderboard_cog.py`
- Line 587: Change `SUM(p.headshot_kills) / SUM(w.hits)` to `SUM(p.headshot_kills) / NULLIF(SUM(p.kills), 0)`
- Line 824: Change `hs / hits * 100` to `hs / kills * 100` (adjust row unpacking)

**Files to change**: `bot/cogs/leaderboard_cog.py`
**Risk**: Low - display only
**Effort**: 15 minutes

### Priority 3: Session Graph Headshot COALESCE (LOW impact, small effort)

**File**: `bot/services/session_graph_generator.py:504`
- Change: `SUM(COALESCE(p.headshots, p.headshot_kills, 0))` to `SUM(p.headshot_kills)`
- The fallback between different stat types is semantically wrong

**Effort**: 5 minutes

### Priority 4: time_played_seconds per-player (LOW-MEDIUM impact, small effort)

**File**: `bot/community_stats_parser.py` around line 989
- After the `for player in players:` loop, add per-player time override from `objective_stats['time_played_minutes']`
- Only affects partial-round players (rare in stopwatch)

**Effort**: 15 minutes, needs testing with edge cases

### Priority 5: Remaining UI issues (MEDIUM impact, needs browser testing)

- Verify availability page routing in `app.js`
- Verify demo upload form submission wiring in `greatshot.js`
- Both need actual browser DevTools debugging, not just code reading

**Effort**: 1-2 hours with browser access

### Priority 6: Proximity reactions table (LOW, feature work)

- Create `proximity_reaction_metric` table migration
- Endpoint code already exists at `api.py:7314-7363`
- Blocked on: defining the table schema and populating data from Lua tracker

### Priority 7: Documentation cleanup (LOW, housekeeping)

- Update SQLite references in `POSTGRESQL_MIGRATION_INDEX.md` and `ADVANCED_TEAM_DETECTION.md`
- Delete stale `config.json` with hardcoded password (local only, not in git)
- Resolve merge conflicts on `wip/forgot-push` branch
- Merge feature branch to main (way behind)

---

*Generated: February 20, 2026*
*Agents: stats-researcher, ui-researcher, infra-researcher, pipeline-researcher*
