# Penetration Test Findings - ET:Legacy Discord Bot

**Date:** 2025-12-14
**Tester:** Claude Code (Automated Security Audit)
**Scope:** Complete codebase security review with attacker mindset
**Status:** COMPLETED

---

## Executive Summary

A comprehensive penetration test was conducted on the ET:Legacy Discord Bot codebase. The assessment focused on identifying exploitable vulnerabilities rather than theoretical risks.

**Overall Security Rating:** ‚ö†Ô∏è **MEDIUM RISK**

**Key Findings:**

- ‚úÖ **SQL Injection:** PROTECTED (parameterized queries used)
- ‚úÖ **Path Traversal:** PROTECTED (strict filename validation)
- ‚úÖ **Code Injection:** PROTECTED (no eval/exec usage)
- ‚ö†Ô∏è **Command Injection:** VULNERABLE (RCON commands)
- ‚ö†Ô∏è **Authorization:** WEAK (channel-based only, no role checks)
- ‚ö†Ô∏è **Information Disclosure:** MINOR (map listing, error messages)
- ‚úÖ **Secrets Management:** ACCEPTABLE (no leakage in logs found)

---

## Critical Findings

### None

No critical vulnerabilities that allow unauthorized remote code execution or full system compromise were found.

---

## High-Risk Findings

### VULN-001: RCON Command Injection (MEDIUM-HIGH)

**File:** `bot/cogs/server_control.py:593`
**Severity:** HIGH (mitigated by admin-only access)
**CVSS Score:** 6.5 (Medium)

**Description:**
The `!map_change` command accepts unsanitized user input and passes it directly to RCON without validation.

**Vulnerable Code:**

```python
@commands.command(name='map_change', aliases=['changemap', 'map'])
async def map_change(self, ctx, map_name: str):
    rcon = ETLegacyRCON(self.rcon_host, self.rcon_port, self.rcon_password)
    rcon.send_command(f'map {map_name}')  # ‚Üê NO SANITIZATION
```text

**Proof of Concept:**

```text

!map_change goldrush; quit

```text

This would send:

```text

rcon PASSWORD map goldrush; quit

```text

Potentially executing multiple RCON commands.

**Impact:**

- Admin can inject arbitrary RCON commands
- Could crash server (quit command)
- Could modify server configuration
- Could kick players maliciously

**Mitigation:**
The `!rcon` command (line 660) properly uses `sanitize_rcon_input()` which removes dangerous characters like `;`, `|`, `&`, backticks. Apply the same sanitization to `map_name`:

```python
safe_map_name = sanitize_rcon_input(map_name)
rcon.send_command(f'map {safe_map_name}')
```python

**Exploitability:** MEDIUM (requires admin channel access)
**Risk:** HIGH (server control compromise)
**Recommendation:** **FIX IMMEDIATELY**

---

### VULN-002: Weak Admin Authorization (HIGH)

**File:** `bot/core/checks.py:35-70`
**Severity:** HIGH
**CVSS Score:** 7.1 (High)

**Description:**
Admin commands use channel-based authorization only, with NO Discord role verification. Anyone who gains access to the admin channel becomes an admin.

**Vulnerable Code:**

```python
def is_admin_channel():
    """
    Decorator: Restrict command to admin channel only.
    ...
    Anyone posting in the admin channel is treated as an admin (no role checks).
    """
    async def predicate(ctx):
        if ctx.channel.id not in admin_channels:
            return False
        return True  # ‚Üê NO ROLE CHECK
```text

**Attack Scenarios:**

1. **Misconfigured Channel Permissions**
   - Discord admin accidentally grants channel read/write to @everyone
   - All users gain admin bot access

2. **Social Engineering**
   - Attacker convinces Discord admin to temporarily grant channel access
   - Attacker runs destructive commands before access revoked

3. **Compromised Moderator**
   - Moderator account compromised
   - If moderator has admin channel access, bot is compromised

**Impact:**

- Unauthorized server control (start/stop/restart)
- Unauthorized RCON access (kick players, change maps)
- Unauthorized database operations
- No audit trail of which user ran commands

**Proof of Concept:**

```text

# Normal user gains access to admin channel

# Immediately runs

!server_stop
!rcon say "Server hacked!"
!kick 5 "Bye"

```text

**Mitigation:**
Add Discord role verification:

```python
def is_admin_channel():
    async def predicate(ctx):
        # Channel check
        if ctx.channel.id not in admin_channels:
            return False

        # Role check (NEW)
        admin_roles = ['Administrator', 'Moderator', 'Bot Admin']
        user_roles = [role.name for role in ctx.author.roles]

        if not any(role in admin_roles for role in user_roles):
            logger.warning(f"‚ö†Ô∏è Unauthorized admin attempt by {ctx.author} in admin channel")
            return False

        return True
```python

**Exploitability:** MEDIUM (requires Discord permission misconfiguration)
**Risk:** CRITICAL (full bot compromise)
**Recommendation:** **FIX IMMEDIATELY**

---

## Medium-Risk Findings

### VULN-003: Information Disclosure via Map Listing (MEDIUM)

**File:** `bot/cogs/server_control.py:450`
**Severity:** MEDIUM
**CVSS Score:** 4.3 (Medium)

**Description:**
The `!map_list` command has NO authorization check, allowing anyone to enumerate installed maps and file paths.

**Vulnerable Code:**

```python
@commands.command(name='map_list', aliases=['maps', 'listmaps'])
async def map_list(self, ctx):  # ‚Üê NO @is_admin_channel() decorator
    """üìã List available maps on server"""
```text

**Impact:**

- Information disclosure (map inventory)
- Server path disclosure (`/home/et/etlegacy-v2.83.1-x86_64/etmain`)
- File size disclosure
- Reconnaissance for future attacks

**Proof of Concept:**

```text

!map_list

```text

Returns:

```text

üó∫Ô∏è Server Maps (1-20 of 47)
‚Ä¢ erdenberg_t2.pk3 (12.3M)
‚Ä¢ goldrush.pk3 (8.7M)
...
Path: /home/et/etlegacy-v2.83.1-x86_64/etmain

```python

**Mitigation:**
Add `@is_admin_channel()` decorator or move to separate public-safe command that doesn't show paths.

**Exploitability:** LOW (information only)
**Risk:** MEDIUM (aids reconnaissance)
**Recommendation:** Add authorization check

---

### VULN-004: SSH Host Key Validation Disabled by Default (MEDIUM)

**File:** `bot/automation/ssh_handler.py:63`
**Severity:** MEDIUM
**CVSS Score:** 5.9 (Medium)

**Description:**
SSH connections use `AutoAddPolicy()` by default, which accepts ANY host key on first connection, making MITM attacks trivial.

**Vulnerable Code:**

```python
if SSH_STRICT_HOST_KEY:
    ssh_client.set_missing_host_key_policy(paramiko.RejectPolicy())
else:
    # Permissive mode: auto-accept host keys (default for trusted VPS)
    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())  # ‚Üê DANGER
```text

**Attack Scenario:**

1. Attacker performs DNS hijacking or ARP spoofing
2. Bot connects to attacker's server instead of real VPS
3. Attacker's SSH server accepted automatically
4. Attacker sends malicious stats files
5. Bot processes them, potentially leading to exploitation

**Impact:**

- Man-in-the-middle attack
- Malicious stats file injection
- Credential theft (SSH key observed)
- Data manipulation

**Mitigation:**
Set `SSH_STRICT_HOST_KEY=true` in production and pre-populate known_hosts:

```bash
ssh-keyscan -p 48101 puran.hehe.si >> ~/.ssh/known_hosts
```yaml

**Exploitability:** LOW (requires network position)
**Risk:** HIGH (complete SSH compromise)
**Recommendation:** Enable strict mode in production

---

## Low-Risk Findings

### INFO-001: No Rate Limiting on Bot Commands (LOW)

**Description:**
Bot commands have no rate limiting, allowing spam/DoS via command flooding.

**Impact:**

- Database connection exhaustion
- CPU exhaustion
- Discord API rate limit
- Bot becomes unresponsive

**Proof of Concept:**

```python
# Spam 1000 commands
for i in range(1000):
    !stats
```yaml

**Recommendation:** Implement per-user rate limiting (e.g., 10 commands/minute).

---

### INFO-002: Error Messages May Leak Information (LOW)

**Description:**
Error messages returned to Discord may contain sensitive path information or stack traces.

**Example:**

```text

‚ùå Error: FileNotFoundError: /home/samba/share/slomix_discord/local_stats/file.txt

```yaml

**Recommendation:** Sanitize all user-facing error messages to remove paths.

---

## Positive Security Findings (What's Done Right)

### ‚úÖ SQL Injection Protection

**All** database queries use parameterized queries via asyncpg:

```python
await conn.execute(
    "INSERT INTO sessions (map_name) VALUES ($1)",
    map_name  # Safe - parameter binding
)
```yaml

**Status:** NO SQL INJECTION VULNERABILITIES FOUND

---

### ‚úÖ Path Traversal Protection

Filename validation is **excellent**:

```python
def _validate_stats_filename(self, filename: str) -> bool:
    # Blocks: /, \, .., null bytes
    if any(char in filename for char in ['/', '\\', '\0']):
        return False
    if '..' in filename:
        return False

    # Strict regex
    pattern = r'^(\d{4})-(\d{2})-(\d{2})-(\d{6})-([a-zA-Z0-9_-]+)-round-(\d+)\.txt$'
    # ... additional validation
```yaml

**Status:** NO PATH TRAVERSAL VULNERABILITIES FOUND

---

### ‚úÖ Code Injection Protection

**No dangerous functions used:**

- ‚ùå `eval()` - Not found
- ‚ùå `exec()` - Not found
- ‚ùå `compile()` - Not found
- ‚ùå `pickle.loads()` - Not found
- ‚ùå Unsafe YAML loading - Not found

**Status:** NO CODE INJECTION VULNERABILITIES FOUND

---

### ‚úÖ Secrets Management

**No secrets leaked in logs:**

- Database passwords redacted
- Bot tokens not logged
- SSH keys not exposed

**Status:** ACCEPTABLE (no leakage found)

---

### ‚úÖ RCON Input Sanitization (Partial)

The `!rcon` command properly sanitizes input:

```python
def sanitize_rcon_input(input_str: str) -> str:
    dangerous_chars = [';', '\n', '\r', '\x00', '`', '$', '|', '&']
    for char in dangerous_chars:
        sanitized = sanitized.replace(char, '')
    return sanitized
```

**Issue:** This function exists but is NOT applied to `!map_change` (VULN-001).

---

## Remediation Roadmap

### Immediate (Fix Now)

1. **VULN-001:** Add sanitization to `!map_change`
   - Apply `sanitize_rcon_input()` to map_name
   - Estimated time: 5 minutes
   - Risk reduction: HIGH

2. **VULN-002:** Add role-based authorization
   - Modify `is_admin_channel()` to check Discord roles
   - Estimated time: 30 minutes
   - Risk reduction: CRITICAL

### Short-term (Within 1 Week)

1. **VULN-003:** Restrict `!map_list` command
   - Add `@is_admin_channel()` decorator
   - Estimated time: 2 minutes

2. **VULN-004:** Enable SSH strict host key checking
   - Set `SSH_STRICT_HOST_KEY=true`
   - Add host key to known_hosts
   - Estimated time: 10 minutes

### Long-term (Within 1 Month)

1. **INFO-001:** Implement rate limiting
   - Add per-user command rate limits
   - Estimated time: 2 hours

2. **INFO-002:** Sanitize error messages
   - Audit all error returns
   - Remove sensitive paths
   - Estimated time: 4 hours

---

## Testing Methodology

### Tools Used

- **Grep/Regex:** Pattern matching for dangerous code
- **Manual Code Review:** Line-by-line analysis of critical paths
- **Static Analysis:** Search for common vulnerability patterns

### Coverage

- ‚úÖ All .py files in bot/ directory scanned
- ‚úÖ SQL injection patterns checked
- ‚úÖ Command injection patterns checked
- ‚úÖ Path traversal patterns checked
- ‚úÖ Authorization mechanisms reviewed
- ‚úÖ Secrets management audited

### Not Tested

- ‚ùå Dynamic testing (actual exploit attempts)
- ‚ùå Fuzzing (random input generation)
- ‚ùå Network-level attacks (MITM simulation)
- ‚ùå Social engineering
- ‚ùå Third-party dependency vulnerabilities

---

## Conclusion

The ET:Legacy Discord Bot has **good baseline security** with proper SQL injection and path traversal protections. However, **two high-risk vulnerabilities** were identified:

1. **RCON command injection** in map_change (admin-exploitable)
2. **Weak authorization** via channel-only checks (permission misconfiguration risk)

**Immediate action required** on both vulnerabilities to prevent potential compromise.

### Final Security Score: 7.5/10

**Breakdown:**

- Code Quality: 8/10 (good practices, parameterized queries)
- Input Validation: 9/10 (excellent filename validation)
- Authorization: 4/10 (weak, channel-based only)
- Secrets Management: 8/10 (no leaks found)
- Error Handling: 6/10 (some information disclosure)

---

**Report Generated:** 2025-12-14
**Next Review:** 2025-12-21 (after remediation)
**Signed:** Claude Code Security Audit
