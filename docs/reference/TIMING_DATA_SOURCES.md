# Timing Data Sources Reference

This document clarifies the different sources of timing data in the Slomix system.

---

## Overview: Three Sources of Timing Data

| Source | Script | Where Stored | Purpose |
|--------|--------|--------------|---------|
| **Stats File** | `oksii-game-stats-web.lua` (c0rnp0rn) | `rounds` table, `player_comprehensive_stats` | Per-player stats, round metadata |
| **Slomix Webhook** | `stats_discord_webhook.lua` | `lua_round_teams` table | Real-time timing fix, team capture |
| **Filename** | Generated by server | `rounds.round_time` | File creation timestamp |

---

## Spawn Tracking (v1.6.0+)

**Script:** `stats_discord_webhook.lua` (Slomix custom)

**Purpose:** Independent dead-time validation using death→spawn intervals.

**What is captured (per player, per round):**
- `spawn_count`
- `death_count`
- `dead_seconds` (sum of death→spawn gaps, plus end-of-round tail if still dead)
- `avg_respawn_seconds`
- `max_respawn_seconds`

**Storage:**
| Location | Type |
|----------|------|
| `gametime-*.json` | `meta.spawn_stats` (full per-player list) |
| `lua_spawn_stats` | DB table (ingested by bot) |

**Note:** This does **not** replace `time_dead_minutes` from stats files; it provides a
second source to validate or identify mismatches.

## Stats File Timing (oksii lua / c0rnp0rn)

**Script:** `oksii-game-stats-web.lua` (runs on game server, writes JSON stats)

**Location in stats file JSON:**
```json
{
  "round_info": {
    "round_start": 12345,           // Milliseconds since map load
    "round_end": 567890,            // Milliseconds since map load
    "round_start_unix": 1737830400, // Unix timestamp
    "round_end_unix": 1737831200    // Unix timestamp
  }
}
```

**Database Storage:**
| Field | Table | Description |
|-------|-------|-------------|
| `time_limit` | `rounds` | Configured map time limit |
| `actual_time` | `rounds` | From stats file (⚠️ BUGGY on surrender) |
| `time_played_seconds` | `player_comprehensive_stats` | Per-player time |
| `time_played_minutes` | `player_comprehensive_stats` | Per-player time (minutes) |
| `time_dead_minutes` | `player_comprehensive_stats` | Time spent dead |
| `time_dead_ratio` | `player_comprehensive_stats` | % of time dead |

**⚠️ Known Bug:** On surrender, `actual_time` shows full map duration (e.g., 20 min) instead of actual played time (e.g., 5 min).

---

## Slomix Webhook Timing (stats_discord_webhook.lua)

**Script:** `stats_discord_webhook.lua` v1.3.0 (our custom script)

**Purpose:** Captures accurate timing by hooking gamestate transitions directly.

**Webhook Fields (v1.3.0):**
| Field | Format | Description |
|-------|--------|-------------|
| `Lua_Playtime` | "847 sec" | Actual playtime excluding pauses |
| `Lua_Warmup` | "45 sec" | Pre-round warmup duration |
| `Lua_Pauses` | "2 (120 sec)" | Pause count and total pause time |
| `Lua_Pauses_JSON` | JSON array | Detailed pause events (v1.3.0+) |
| `Lua_Timelimit` | "20 min" | Configured map time |
| `Lua_RoundStart` | Unix timestamp | When GS_PLAYING began |
| `Lua_RoundEnd` | Unix timestamp | When GS_INTERMISSION began |
| `Lua_WarmupStart` | Unix timestamp | When warmup phase began |
| `Lua_WarmupEnd` | Unix timestamp | When warmup ended (= round start) (v1.3.0+) |
| `Lua_EndReason` | "objective/surrender/time_expired" | How round ended |

**Pause Events JSON Format (v1.3.0+):**
```json
[
  {"n": 1, "start": 1737752100, "end": 1737752130, "sec": 30},
  {"n": 2, "start": 1737752300, "end": 1737752330, "sec": 30}
]
```

**Webhook Embed Legend (v1.3.0+):**
The webhook includes a description explaining timing terms:
- **Playtime** = actual gameplay (pauses excluded)
- **Warmup** = waiting before round
- **Wall-clock** = WarmupStart→RoundEnd

**Database Storage (`lua_round_teams` table):**
| Column | Type | Description |
|--------|------|-------------|
| `round_start_unix` | BIGINT | When GS_PLAYING started |
| `round_end_unix` | BIGINT | When GS_INTERMISSION started |
| `actual_duration_seconds` | INTEGER | Playtime excluding pauses |
| `total_pause_seconds` | INTEGER | Total pause time |
| `pause_count` | INTEGER | Number of pauses |
| `lua_warmup_seconds` | INTEGER | Warmup duration (v1.2.0+) |
| `lua_warmup_start_unix` | BIGINT | Warmup start timestamp (v1.2.0+) |
| `lua_pause_events` | JSONB | Pause event array with timestamps (v1.3.0+) |
| `end_reason` | VARCHAR | How round ended |

---

## Computed Timing (Bot-Side Aggregation)

The bot can compute these from webhook timestamps:

```
Intermission (R1→R2) = R2.lua_warmup_start_unix - R1.round_end_unix

Map Totals:
  Total playtime  = R1.actual_duration_seconds + R2.actual_duration_seconds
  Total warmup    = R1.lua_warmup_seconds + R2.lua_warmup_seconds
  Total pauses    = R1.total_pause_seconds + R2.total_pause_seconds
  Wall-clock time = R2.round_end_unix - R1.lua_warmup_start_unix

Session Totals: Sum across all rounds in gaming_session_id
```

---

## Visual Timeline

```
MAP LOAD
   │
   ├──► warmup_start_unix ──────────────────┐
   │                                         │ lua_warmup_seconds
   │    [GS_WARMUP] → [GS_WARMUP_COUNTDOWN] │
   │                                         │
   ├──► round_start_unix ◄──────────────────┘
   │
   │    [GS_PLAYING]
   │    ├── pause_start → pause_end ──► total_pause_seconds
   │    └── (live gameplay)
   │
   ├──► round_end_unix
   │
   │    [GS_INTERMISSION] ← Round 1 ends here
   │
   ├──► R2.warmup_start_unix ──────────────┐
   │                                        │ (intermission = this - R1.round_end_unix)
   │    [R2 warmup...]                     │
   │                                        │
   └──► (R2 continues same pattern...)
```

---

## Naming Convention

All fields from our webhook use the `Lua_` or `lua_` prefix:

| Prefix | Source | Example |
|--------|--------|---------|
| `Lua_` | Webhook embed field | `Lua_Playtime`, `Lua_Warmup` |
| `lua_` | Database column | `lua_warmup_seconds`, `lua_warmup_start_unix` |
| (none) | Stats file / legacy | `round_start_unix`, `actual_duration_seconds` |

**Note:** Some legacy columns in `lua_round_teams` don't have the prefix (e.g., `round_start_unix`, `actual_duration_seconds`) because they were created before the naming convention. These still come from our Lua webhook, not the stats file.

---

## Which Source to Use?

| Use Case | Recommended Source |
|----------|-------------------|
| Accurate round duration | `lua_round_teams.actual_duration_seconds` |
| Per-player playtime | `player_comprehensive_stats.time_played_seconds` |
| Pause tracking | `lua_round_teams.total_pause_seconds` |
| Warmup duration | `lua_round_teams.lua_warmup_seconds` |
| Intermission duration | Compute: `R2.lua_warmup_start_unix - R1.round_end_unix` |
| Surrender detection | Compare `rounds.actual_time` vs `lua_round_teams.actual_duration_seconds` |

---

## Version History

| Version | Changes |
|---------|---------|
| v1.1.0 | Initial webhook with playtime, pauses, team capture |
| v1.2.0 | Added warmup tracking (`Lua_Warmup`, `Lua_WarmupStart`), renamed fields with `Lua_` prefix |
| v1.3.0 | Added pause event timestamps (`Lua_Pauses_JSON`), warmup end timestamp (`Lua_WarmupEnd`), timing legend in embed |

---

## Database Migrations

| Migration | Description |
|-----------|-------------|
| `001_add_timing_metadata_columns.sql` | Timing columns on `rounds` table |
| `002_add_lua_round_teams_table.sql` | Create `lua_round_teams` table |
| `003_add_warmup_columns.sql` | Add `lua_warmup_seconds`, `lua_warmup_start_unix` |
| `004_add_pause_events.sql` | Add `lua_pause_events` JSONB column |
