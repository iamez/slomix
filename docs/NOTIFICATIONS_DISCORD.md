# Availability Notifications - Discord

## Scope
Discord is used for:
- Availability input command (`!avail ...`)
- Direct-message event notifications to linked users
- Optional channel announcements for major events (for example `SESSION_READY`)

## Requirements
- User must be linked in `player_links`.
- Website settings / subscriptions determine whether Discord notifications remain enabled.
- Idempotency is enforced by `notifications_ledger` with unique `(user_id, event_key, channel_type)`.

## Commands
- `!avail <today|tomorrow|YYYY-MM-DD> <LOOKING|AVAILABLE|MAYBE|NOT_PLAYING>`
- `!avail_unsubscribe discord`

## Event Types
Generated by bot scheduler:
- `DAILY_REMINDER`
- `SESSION_READY`

Event keys:
- `DAILY_REMINDER:YYYY-MM-DD`
- `SESSION_READY:YYYY-MM-DD:threshold=N`

## Config Flags
From `bot/config.py`:
- `AVAILABILITY_DISCORD_DM_ENABLED`
- `AVAILABILITY_DISCORD_CHANNEL_ANNOUNCE_ENABLED`
- `AVAILABILITY_DISCORD_ANNOUNCE_CHANNEL_ID`
- `AVAILABILITY_SESSION_READY_THRESHOLD`

## Verification
1. Run `!avail today LOOKING` as linked user.
2. Confirm row exists in `availability_entries`.
3. Trigger threshold and confirm DM received.
4. Re-trigger same event key and verify no duplicate DM.
5. Check `notifications_ledger` for sent/error metadata.
