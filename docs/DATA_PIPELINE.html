<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ET:Legacy Stats Pipeline - Complete Data Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #58a6ff;
            border-bottom: 3px solid #58a6ff;
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #79c0ff;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 10px;
            background: #161b22;
            border-left: 4px solid #79c0ff;
        }
        
        h3 {
            color: #f778ba;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .terminology {
            background: #1c2128;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .term {
            display: inline-block;
            background: #388bfd;
            color: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            margin: 5px;
            font-weight: bold;
        }
        
        .term.round { background: #3fb950; }
        .term.map { background: #d29922; }
        .term.session { background: #a371f7; }
        
        .stage {
            background: #161b22;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stage-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stage-number {
            background: #58a6ff;
            color: #0d1117;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            margin-right: 15px;
        }
        
        .stage-title {
            font-size: 1.5em;
            color: #79c0ff;
        }
        
        .datapoint {
            background: #0d1117;
            border-left: 3px solid #58a6ff;
            padding: 15px;
            margin: 10px 0;
        }
        
        .datapoint-header {
            color: #f778ba;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .datapoint-flow {
            color: #8b949e;
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .arrow {
            color: #58a6ff;
            margin: 0 10px;
        }
        
        .highlight-round1 {
            background: #1a472a;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .highlight-round2 {
            background: #6e1810;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 0.9em;
        }
        
        .diff {
            margin: 10px 0;
        }
        
        .diff-round1 {
            color: #3fb950;
        }
        
        .diff-round2 {
            color: #f85149;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #161b22;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #30363d;
        }
        
        th {
            background: #21262d;
            color: #58a6ff;
            font-weight: bold;
        }
        
        tr:hover {
            background: #1c2128;
        }
        
        .timing {
            color: #d29922;
            font-weight: bold;
        }
        
        .sql-query {
            background: #161b22;
            border-left: 4px solid #f778ba;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            color: #79c0ff;
        }
        
        .decision-tree {
            background: #1c2128;
            border: 2px dashed #58a6ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .decision {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .yes { color: #3fb950; font-weight: bold; }
        .no { color: #f85149; font-weight: bold; }
        
        .warning {
            background: #4c2909;
            border-left: 4px solid #d29922;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .info {
            background: #0c2d6b;
            border-left: 4px solid #58a6ff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ ET:Legacy Stats Pipeline - Every Single Data Point</h1>
        
        <div class="terminology">
            <h3>üìö Correct Terminology:</h3>
            <span class="term round">ROUND</span> = One half of a map (Round 1: Allies attack, Round 2: Axis attack)<br>
            <span class="term map">MAP/MATCH</span> = Contains 2 rounds (stopwatch mode)<br>
            <span class="term session">GAMING SESSION</span> = Multiple maps played continuously (gaps < 60 min)
            
            <div style="margin-top: 20px; color: #8b949e;">
                <strong>Example:</strong><br>
                Gaming Session 1 (3 maps, 6 rounds total):<br>
                &nbsp;&nbsp;‚îú‚îÄ Map 1: Goldrush ‚Üí Round 1 (Allies attack) + Round 2 (Axis attack)<br>
                &nbsp;&nbsp;‚îú‚îÄ Map 2: Supply ‚Üí Round 1 (Allies attack) + Round 2 (Axis attack)<br>
                &nbsp;&nbsp;‚îî‚îÄ Map 3: Radar ‚Üí Round 1 (Allies attack) + Round 2 (Axis attack)
            </div>
        </div>

        <h2>üîç THE KEY QUESTION: Where Does Round 2 Differ?</h2>
        
        <div class="info">
            <strong>ANSWER:</strong> Round 2 processing differs from Round 1 in <strong>ONE PLACE ONLY</strong>:<br>
            <strong>Stage 5 ‚Üí Step 3 ‚Üí gaming_session_id calculation</strong><br><br>
            Everything else (file detection, download, parsing, validation, database inserts, logging) is <strong>IDENTICAL</strong>.
        </div>

        <!-- STAGE 1 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">1</div>
                <div class="stage-title">Server File Creation</div>
            </div>
            
            <h3>üìÑ Every Data Point Origin:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">File: gamestats_2025-11-06_20-00-00_goldrush_r1.txt</div>
                <div class="datapoint-flow">
                    Created by: ET:Legacy server mod (c0rnp0rn.lua)<br>
                    Location: et@puran.hehe.si:/srv/etlegacy/legacy/etmain/gamestats/<br>
                    Timestamp: End of round (when last objective completed OR time expires)<br>
                    Size: ~5-15 KB
                </div>
            </div>
            
            <div class="code-block">
                <strong>Contents (52 player fields √ó 8 players + ~45 weapons):</strong><br><br>
                
                <strong>Round Metadata (5 fields):</strong><br>
                map_name: goldrush<br>
                round_date: 2025-11-06<br>
                round_time: 20:00:00<br>
                round_duration: 900 (seconds)<br>
                winning_team: Allies<br><br>
                
                <strong>Per-Player Data (52 fields √ó 8 players = 416 data points):</strong><br>
                player_name, player_guid, team, kills, deaths, headshots, revives, heals, damage_given, damage_received, assists, team_kills, self_kills, gibs, accuracy, headshot_percentage, kd_ratio, kills_per_death, headshots_per_kill, revives_per_death, damage_efficiency, survival_rate, objectives_completed, defused, planted, constructed, destructed, captures, stolen, returned, protected, flag_time, objective_time, ammo_given, health_given, poison_given, stamina_given, adrenaline_given, backstabs, melee_kills, satchel_kills, landmine_kills, mg_kills, sniper_kills, panzer_kills, flamer_kills, arty_kills, airstrike_kills, grenade_kills, knife_kills, luger_kills, ...<br><br>
                
                <strong>Weapon Stats (~45 weapons √ó 8 players = ~360 data points):</strong><br>
                weapon_name, player_guid, kills, deaths, headshots, accuracy, shots_fired, shots_hit, damage_dealt
            </div>
            
            <div class="diff">
                <div class="diff-round1">‚úì Round 1 file: gamestats_2025-11-06_20-00-00_goldrush_r1.txt</div>
                <div class="diff-round2">‚úì Round 2 file: gamestats_2025-11-06_20-15-00_goldrush_r2.txt</div>
                <strong>Difference:</strong> ONLY the filename suffix (_r1 vs _r2). Content structure is IDENTICAL.
            </div>
        </div>

        <!-- STAGE 2 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">2</div>
                <div class="stage-title">SSH File Monitor & Download</div>
            </div>
            
            <h3>üîΩ Data Point Journey:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">monitor_stats.py (SSH Monitor)</div>
                <div class="datapoint-flow">
                    Every 5 seconds:<br>
                    1. SSH into server<br>
                    2. Execute: <code>ls -1 /srv/etlegacy/legacy/etmain/gamestats/*.txt</code><br>
                    3. Compare with local processed_files.json<br>
                    4. If new file found ‚Üí download via SCP<br>
                    5. Save to: C:\Users\seareal\Documents\stats\local_stats\
                </div>
            </div>
            
            <div class="code-block">
                <strong>Data Points Transferred:</strong><br>
                Source: et@puran.hehe.si:/srv/etlegacy/legacy/etmain/gamestats/gamestats_2025-11-06_20-00-00_goldrush_r1.txt<br>
                Destination: C:\Users\seareal\Documents\stats\local_stats\gamestats_2025-11-06_20-00-00_goldrush_r1.txt<br>
                Transfer method: SCP (Secure Copy Protocol)<br>
                Transfer time: <span class="timing">~0.5-2 seconds</span> (depends on network)<br>
                Data integrity: SHA256 checksum verified (implicit in SCP)
            </div>
            
            <div class="diff">
                <strong>Round 1 vs Round 2:</strong> IDENTICAL process. No difference.
            </div>
        </div>

        <!-- STAGE 3 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">3</div>
                <div class="stage-title">File Parsing - C0RNP0RN3StatsParser</div>
            </div>
            
            <h3>üî¨ Every Data Point Extraction:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">Input: Raw text file (5-15 KB)</div>
                <div class="datapoint-flow">
                    Parser reads: C:\Users\seareal\Documents\stats\local_stats\gamestats_2025-11-06_20-00-00_goldrush_r1.txt<br>
                    Parser class: C0RNP0RN3StatsParser (in c0rnp0rn_stats_parser.py)<br>
                    Method: parse_file(filepath) ‚Üí returns dict
                </div>
            </div>
            
            <div class="sql-query">
                <strong>Data Point Transformation:</strong><br><br>
                
                <strong>Step 1: Extract filename metadata</strong><br>
                filename: "gamestats_2025-11-06_20-00-00_goldrush_r1.txt"<br>
                ‚Üì regex: r'gamestats_(\d{4}-\d{2}-\d{2})_(\d{2}-\d{2}-\d{2})_(.+?)_r(\d)\.txt'<br>
                ‚Üì<br>
                round_date: "2025-11-06"<br>
                round_time: "20:00:00"<br>
                map_name: "goldrush"<br>
                round_number: 1<br><br>
                
                <strong>Step 2: Parse round metadata (5 fields)</strong><br>
                Read line: "round_duration: 900"<br>
                ‚Üì split on ':' ‚Üí ["round_duration", "900"]<br>
                ‚Üì<br>
                round_duration: 900 (int)<br><br>
                
                Read line: "winning_team: Allies"<br>
                ‚Üì<br>
                winning_team: "Allies" (str)<br><br>
                
                <strong>Step 3: Parse player data (52 fields √ó 8 players)</strong><br>
                For each player section:<br>
                Read line: "player_name: carniee"<br>
                ‚Üì store in player_stats[0]['player_name'] = "carniee"<br><br>
                
                Read line: "kills: 42"<br>
                ‚Üì store in player_stats[0]['kills'] = 42<br><br>
                
                Read line: "deaths: 15"<br>
                ‚Üì store in player_stats[0]['deaths'] = 15<br><br>
                
                ... (50 more fields per player) ...<br><br>
                
                <strong>Step 4: Parse weapon stats (45 weapons √ó 8 players)</strong><br>
                Read line: "mp40: kills=25, deaths=3, headshots=8, accuracy=35.2"<br>
                ‚Üì parse weapon block<br>
                ‚Üì<br>
                weapon_stats[0] = {<br>
                &nbsp;&nbsp;'weapon_name': 'mp40',<br>
                &nbsp;&nbsp;'player_guid': 'ABC123...',<br>
                &nbsp;&nbsp;'kills': 25,<br>
                &nbsp;&nbsp;'deaths': 3,<br>
                &nbsp;&nbsp;'headshots': 8,<br>
                &nbsp;&nbsp;'accuracy': 35.2<br>
                }<br><br>
                
                <strong>Output: Structured dictionary</strong><br>
                {<br>
                &nbsp;&nbsp;'round_date': '2025-11-06',<br>
                &nbsp;&nbsp;'round_time': '20:00:00',<br>
                &nbsp;&nbsp;'map_name': 'goldrush',<br>
                &nbsp;&nbsp;'round_duration': 900,<br>
                &nbsp;&nbsp;'winning_team': 'Allies',<br>
                &nbsp;&nbsp;'player_stats': [ ... 8 players with 52 fields each ... ],<br>
                &nbsp;&nbsp;'weapon_stats': [ ... ~360 weapon records ... ]<br>
                }
            </div>
            
            <div class="diff">
                <strong>Round 1 vs Round 2:</strong> IDENTICAL parsing logic. No difference.<br>
                Only difference: round_number extracted from filename (1 vs 2)
            </div>
            
            <div class="code-block">
                <strong>Total Data Points Extracted:</strong><br>
                Round metadata: 5 fields<br>
                Player stats: 52 fields √ó 8 players = 416 data points<br>
                Weapon stats: 8 fields √ó 45 weapons √ó 8 players = ~360 data points<br>
                <strong>TOTAL: ~781 data points per round</strong><br>
                <strong>Parse time: <span class="timing">~0.3-0.8 seconds</span></strong>
            </div>
        </div>

        <!-- STAGE 4 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">4</div>
                <div class="stage-title">Validation - 7 Comprehensive Checks</div>
            </div>
            
            <h3>‚úÖ Every Data Point Validation:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 1: Kill/Death Balance</div>
                <div class="datapoint-flow">
                    Sum all player kills: 42 + 38 + 29 + ... = 245<br>
                    Sum all player deaths: 15 + 22 + 18 + ... = 240<br>
                    Difference: |245 - 240| = 5<br>
                    ‚úì PASS (within ¬±5 tolerance)
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 2: Headshot Percentage Accuracy</div>
                <div class="datapoint-flow">
                    For each player:<br>
                    &nbsp;&nbsp;carniee: kills=42, headshots=15<br>
                    &nbsp;&nbsp;Calculated: 15/42 = 35.7%<br>
                    &nbsp;&nbsp;Stored: 35.7%<br>
                    &nbsp;&nbsp;‚úì PASS (match)
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 3: K/D Ratio Accuracy</div>
                <div class="datapoint-flow">
                    For each player:<br>
                    &nbsp;&nbsp;carniee: kills=42, deaths=15<br>
                    &nbsp;&nbsp;Calculated: 42/15 = 2.8<br>
                    &nbsp;&nbsp;Stored: 2.8<br>
                    &nbsp;&nbsp;‚úì PASS (match)
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 4: Team Distribution (Round 1 ONLY)</div>
                <div class="datapoint-flow">
                    Count players per team:<br>
                    &nbsp;&nbsp;Allies: 4 players<br>
                    &nbsp;&nbsp;Axis: 4 players<br>
                    &nbsp;&nbsp;‚úì PASS (balanced teams)
                </div>
            </div>
            
            <div class="warning">
                <strong>Round 2 Difference:</strong> Team distribution check is SKIPPED for Round 2!<br>
                Why? In stopwatch mode, teams swap sides. Round 1 Allies become Round 2 Axis.<br>
                File parsing might not capture swapped teams correctly, so we don't validate it.
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 5: Weapon Stats Coherence</div>
                <div class="datapoint-flow">
                    For each weapon:<br>
                    &nbsp;&nbsp;mp40: shots_fired=350, shots_hit=123<br>
                    &nbsp;&nbsp;Accuracy: 123/350 = 35.1%<br>
                    &nbsp;&nbsp;Stored accuracy: 35.1%<br>
                    &nbsp;&nbsp;‚úì PASS (match)
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 6: Player Count</div>
                <div class="datapoint-flow">
                    Minimum players: 4<br>
                    Actual players: 8<br>
                    ‚úì PASS (‚â• 4 players)
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Check 7: Required Fields Present</div>
                <div class="datapoint-flow">
                    Check all 52 player fields exist for each player<br>
                    Check all 5 round metadata fields exist<br>
                    ‚úì PASS (all fields present)
                </div>
            </div>
            
            <div class="diff">
                <strong>Round 1:</strong> All 7 checks run<br>
                <strong>Round 2:</strong> Only 6 checks run (team distribution skipped)<br>
                <strong>Validation time: <span class="timing">~0.1-0.2 seconds</span></strong>
            </div>
        </div>

        <!-- STAGE 5 - THE CRITICAL ONE -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">5</div>
                <div class="stage-title">Database Transaction - THIS IS WHERE ROUND 2 DIFFERS</div>
            </div>
            
            <h3>üéØ CRITICAL: gaming_session_id Calculation</h3>
            
            <div class="info">
                <strong>THIS IS THE ONLY STAGE WHERE ROUND 1 AND ROUND 2 DIFFER!</strong>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 1: Start PostgreSQL Transaction</div>
                <div class="datapoint-flow">
                    conn = psycopg2.connect(database="etlegacy", user="etlegacy_user", ...)<br>
                    cursor = conn.cursor()<br>
                    cursor.execute("BEGIN TRANSACTION;")
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 2: Check if file already processed</div>
                <div class="datapoint-flow">
                    <strong>SQL Query:</strong><br>
                    SELECT COUNT(*) FROM processed_files<br>
                    WHERE filename = 'gamestats_2025-11-06_20-00-00_goldrush_r1.txt';<br><br>
                    
                    Result: 0 (not processed yet)<br>
                    ‚úì Continue
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 3: Calculate gaming_session_id ‚ö†Ô∏è ROUND 2 DIFFERS HERE!</div>
                <div class="datapoint-flow">
                    <strong>Method: _get_or_create_gaming_session_id()</strong>
                </div>
            </div>
            
            <div class="decision-tree">
                <h3 style="color: #f778ba; margin-bottom: 15px;">üîÄ Decision Tree: gaming_session_id</h3>
                
                <div class="sql-query" style="background: #0d1117;">
                    <strong>QUERY 1: Get last round</strong><br>
                    SELECT gaming_session_id, round_date, round_time<br>
                    FROM rounds<br>
                    WHERE gaming_session_id IS NOT NULL<br>
                    ORDER BY round_date DESC, round_time DESC<br>
                    LIMIT 1;
                </div>
                
                <div class="decision">
                    <strong>If NO previous round found:</strong><br>
                    <span class="yes">‚Üí gaming_session_id = 1</span><br>
                    <span style="color: #8b949e;">(This is the FIRST ROUND EVER in the database)</span>
                </div>
                
                <div class="decision">
                    <strong>If previous round EXISTS:</strong><br><br>
                    
                    <div class="code-block">
                        <strong>Example Round 1 Scenario:</strong><br>
                        Query returns: <span class="no">NOTHING (no previous rounds)</span><br>
                        ‚Üì<br>
                        gaming_session_id = 1<br><br>
                        
                        <strong>Example Round 2 Scenario (same map, 15 min later):</strong><br>
                        Query returns:<br>
                        &nbsp;&nbsp;gaming_session_id: 1<br>
                        &nbsp;&nbsp;round_date: 2025-11-06<br>
                        &nbsp;&nbsp;round_time: 20:00:00<br><br>
                        
                        Current round:<br>
                        &nbsp;&nbsp;round_date: 2025-11-06<br>
                        &nbsp;&nbsp;round_time: 20:15:00<br><br>
                        
                        <strong>Calculate time gap:</strong><br>
                        last_datetime = datetime(2025, 11, 6, 20, 0, 0)<br>
                        current_datetime = datetime(2025, 11, 6, 20, 15, 0)<br>
                        gap = current_datetime - last_datetime<br>
                        gap_minutes = gap.total_seconds() / 60<br>
                        gap_minutes = 15.0<br><br>
                        
                        <strong>Decision:</strong><br>
                        if gap_minutes > 60:<br>
                        &nbsp;&nbsp;<span class="no">NO (15 ‚â§ 60)</span><br>
                        &nbsp;&nbsp;‚Üí gaming_session_id = 1 (SAME SESSION!)<br><br>
                        
                        <strong>Example Round 10 Scenario (2 hours later):</strong><br>
                        Query returns:<br>
                        &nbsp;&nbsp;gaming_session_id: 1<br>
                        &nbsp;&nbsp;round_date: 2025-11-06<br>
                        &nbsp;&nbsp;round_time: 20:30:00<br><br>
                        
                        Current round:<br>
                        &nbsp;&nbsp;round_date: 2025-11-06<br>
                        &nbsp;&nbsp;round_time: 22:45:00<br><br>
                        
                        <strong>Calculate time gap:</strong><br>
                        gap_minutes = 135.0<br><br>
                        
                        <strong>Decision:</strong><br>
                        if gap_minutes > 60:<br>
                        &nbsp;&nbsp;<span class="yes">YES (135 > 60)</span><br>
                        &nbsp;&nbsp;‚Üí gaming_session_id = 2 (NEW SESSION!)
                    </div>
                </div>
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è THIS IS THE ONLY DIFFERENCE BETWEEN ROUND 1 AND ROUND 2!</strong><br><br>
                
                <strong>Round 1:</strong> No previous rounds exist ‚Üí gaming_session_id = 1<br>
                <strong>Round 2:</strong> Previous round exists (15 min ago) ‚Üí Check gap ‚Üí gaming_session_id = 1 (same session)<br>
                <strong>Round 10:</strong> Previous round exists (2 hours ago) ‚Üí Check gap ‚Üí gaming_session_id = 2 (NEW session)
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 4: Insert into rounds table</div>
                <div class="datapoint-flow">
                    <strong>SQL INSERT:</strong><br>
                    INSERT INTO rounds (<br>
                    &nbsp;&nbsp;round_date, round_time, map_name, round_duration, winning_team, gaming_session_id<br>
                    ) VALUES (<br>
                    &nbsp;&nbsp;'2025-11-06', '20:00:00', 'goldrush', 900, 'Allies', 1<br>
                    ) RETURNING round_id;<br><br>
                    
                    Result: round_id = 246<br><br>
                    
                    <strong>Data points saved: 6 fields</strong>
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 5: Insert player stats (52 fields √ó 8 players)</div>
                <div class="datapoint-flow">
                    For each player (8 iterations):<br><br>
                    
                    <strong>SQL INSERT:</strong><br>
                    INSERT INTO player_comprehensive_stats (<br>
                    &nbsp;&nbsp;round_id, player_name, player_guid, team, kills, deaths, headshots,<br>
                    &nbsp;&nbsp;revives, heals, damage_given, damage_received, assists, team_kills,<br>
                    &nbsp;&nbsp;self_kills, gibs, accuracy, headshot_percentage, kd_ratio,<br>
                    &nbsp;&nbsp;... (all 52 fields) ...<br>
                    ) VALUES (<br>
                    &nbsp;&nbsp;246, 'carniee', 'ABC123...', 'Allies', 42, 15, 15,<br>
                    &nbsp;&nbsp;... (all 52 values) ...<br>
                    );<br><br>
                    
                    <strong>Data points saved: 52 fields √ó 8 players = 416 data points</strong>
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 6: Insert weapon stats (~45 weapons √ó 8 players)</div>
                <div class="datapoint-flow">
                    For each weapon record (~360 iterations):<br><br>
                    
                    <strong>SQL INSERT:</strong><br>
                    INSERT INTO weapon_comprehensive_stats (<br>
                    &nbsp;&nbsp;round_id, player_guid, weapon_name, kills, deaths, headshots,<br>
                    &nbsp;&nbsp;accuracy, shots_fired, shots_hit, damage_dealt<br>
                    ) VALUES (<br>
                    &nbsp;&nbsp;246, 'ABC123...', 'mp40', 25, 3, 8, 35.2, 350, 123, 2500<br>
                    );<br><br>
                    
                    <strong>Data points saved: 9 fields √ó ~360 records = ~3,240 data points</strong>
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 7: Mark file as processed</div>
                <div class="datapoint-flow">
                    <strong>SQL INSERT:</strong><br>
                    INSERT INTO processed_files (<br>
                    &nbsp;&nbsp;filename, processed_at<br>
                    ) VALUES (<br>
                    &nbsp;&nbsp;'gamestats_2025-11-06_20-00-00_goldrush_r1.txt', NOW()<br>
                    );
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Step 8: Commit Transaction</div>
                <div class="datapoint-flow">
                    cursor.execute("COMMIT;");<br>
                    conn.close();<br><br>
                    
                    <strong>Total transaction time: <span class="timing">~1.5-3 seconds</span></strong><br>
                    <strong>Total data points saved: ~3,662 per round</strong>
                </div>
            </div>
            
            <div class="diff">
                <strong>Round 1 vs Round 2 Transaction:</strong><br>
                <span class="diff-round1">Round 1: gaming_session_id = 1 (no query needed)</span><br>
                <span class="diff-round2">Round 2: gaming_session_id = 1 (after gap check query)</span><br>
                All other SQL INSERTs are IDENTICAL!
            </div>
        </div>

        <!-- STAGE 6 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">6</div>
                <div class="stage-title">Logging System</div>
            </div>
            
            <h3>üìù Every Data Point Logged:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">Log Entry: database.log</div>
                <div class="datapoint-flow">
                    <strong>What's logged:</strong><br>
                    - SQL query: SELECT gaming_session_id... (if Round 2+)<br>
                    - Query duration: 0.015 seconds<br>
                    - INSERT queries for rounds, player_stats, weapon_stats<br>
                    - Row counts: 1 round, 8 players, 360 weapons<br>
                    - Transaction duration: 2.1 seconds
                </div>
            </div>
            
            <div class="datapoint">
                <div class="datapoint-header">Log Entry: bot.log</div>
                <div class="datapoint-flow">
                    <strong>What's logged:</strong><br>
                    [INFO] Processing file: gamestats_2025-11-06_20-00-00_goldrush_r1.txt<br>
                    [INFO] Parsed: 8 players, 360 weapons<br>
                    [INFO] Validation: 7 checks passed<br>
                    [INFO] Database: Saved successfully<br>
                    [INFO] Total processing time: 2.8 seconds
                </div>
            </div>
            
            <div class="diff">
                <strong>Round 1 vs Round 2:</strong> IDENTICAL logging. No difference.
            </div>
        </div>

        <!-- STAGE 7 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">7</div>
                <div class="stage-title">Voice Channel Detection (Optional)</div>
            </div>
            
            <h3>üé§ Automatic Discord Posting:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">If voice_channel_monitor enabled:</div>
                <div class="datapoint-flow">
                    Check if 4+ users in voice channel ‚Üí trigger !last_session automatically<br>
                    This is OPTIONAL and disabled by default
                </div>
            </div>
            
            <div class="diff">
                <strong>Round 1 vs Round 2:</strong> IDENTICAL. No difference.
            </div>
        </div>

        <!-- STAGE 8 -->
        <div class="stage">
            <div class="stage-header">
                <div class="stage-number">8</div>
                <div class="stage-title">Discord Command Display</div>
            </div>
            
            <h3>üí¨ Data Point Presentation:</h3>
            
            <div class="datapoint">
                <div class="datapoint-header">User types: !last_session</div>
                <div class="datapoint-flow">
                    <strong>Step 1: Find current session</strong><br>
                    SELECT MAX(gaming_session_id) FROM rounds;<br>
                    Result: 1<br><br>
                    
                    <strong>Step 2: Get all rounds in session</strong><br>
                    SELECT * FROM rounds WHERE gaming_session_id = 1;<br>
                    Result: 2 rounds (Round 1 + Round 2 of goldrush map)<br><br>
                    
                    <strong>Step 3: Aggregate player stats</strong><br>
                    SELECT player_name, SUM(kills), SUM(deaths), SUM(headshots), ...<br>
                    FROM player_comprehensive_stats<br>
                    WHERE round_id IN (246, 247)<br>
                    GROUP BY player_name;<br><br>
                    
                    Result: Combined stats for both rounds!<br>
                    carniee: 85 kills (42 from R1 + 43 from R2), 30 deaths (15 from R1 + 15 from R2)<br><br>
                    
                    <strong>Step 4: Generate embeds and graphs</strong><br>
                    - Top performer embed (MVP)<br>
                    - Team stats embed<br>
                    - Weapon mastery embed<br>
                    - Performance graph (matplotlib)<br>
                    - Combat efficiency graph<br><br>
                    
                    <strong>Step 5: Post to Discord</strong><br>
                    Send all embeds + attach 2 graph PNG files
                </div>
            </div>
            
            <div class="info">
                <strong>KEY INSIGHT:</strong> Because Round 1 and Round 2 both have gaming_session_id = 1,<br>
                the !last_session command shows COMBINED stats from both rounds of the map!<br><br>
                
                This is WHY the gaming_session_id calculation is so important!<br>
                It determines which rounds are grouped together in Discord displays.
            </div>
            
            <div class="diff">
                <strong>Round 1 alone:</strong> Shows stats from 1 round only<br>
                <strong>Round 1 + Round 2:</strong> Shows COMBINED stats from both rounds (complete map)<br>
                <strong>After 60+ min break:</strong> Shows NEW session (excludes old rounds)
            </div>
        </div>

        <h2>üìä Complete Data Flow Summary</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Data Points In</th>
                    <th>Data Points Out</th>
                    <th>Time</th>
                    <th>Round 1 vs Round 2</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1. Server File</td>
                    <td>Game engine data</td>
                    <td>~781 data points (text file)</td>
                    <td>0s</td>
                    <td>IDENTICAL</td>
                </tr>
                <tr>
                    <td>2. SSH Download</td>
                    <td>Remote file</td>
                    <td>Local file copy</td>
                    <td>0.5-2s</td>
                    <td>IDENTICAL</td>
                </tr>
                <tr>
                    <td>3. Parser</td>
                    <td>Text file</td>
                    <td>Python dict (781 data points)</td>
                    <td>0.3-0.8s</td>
                    <td>IDENTICAL</td>
                </tr>
                <tr>
                    <td>4. Validation</td>
                    <td>Python dict</td>
                    <td>Validated dict</td>
                    <td>0.1-0.2s</td>
                    <td>Round 1: 7 checks<br>Round 2: 6 checks</td>
                </tr>
                <tr>
                    <td>5. Database</td>
                    <td>Validated dict</td>
                    <td>~3,662 PostgreSQL rows</td>
                    <td>1.5-3s</td>
                    <td><strong>DIFFERS HERE!</strong><br>gaming_session_id calc</td>
                </tr>
                <tr>
                    <td>6. Logging</td>
                    <td>All operations</td>
                    <td>4 log files</td>
                    <td>~0.1s</td>
                    <td>IDENTICAL</td>
                </tr>
                <tr>
                    <td>7. Voice Monitor</td>
                    <td>Voice channel state</td>
                    <td>Auto-trigger (optional)</td>
                    <td>0s</td>
                    <td>IDENTICAL</td>
                </tr>
                <tr>
                    <td>8. Discord</td>
                    <td>Database query</td>
                    <td>Embeds + graphs</td>
                    <td>2-4s</td>
                    <td>IDENTICAL</td>
                </tr>
            </tbody>
        </table>
        
        <h2>üéØ The ONE Critical Difference</h2>
        
        <div class="info" style="font-size: 1.2em; padding: 30px;">
            <strong>LOCATION:</strong> Stage 5 ‚Üí Step 3 ‚Üí gaming_session_id calculation<br><br>
            
            <strong>ROUND 1:</strong><br>
            No previous rounds exist ‚Üí gaming_session_id = 1<br>
            No database query needed<br>
            Processing time: ~2 seconds<br><br>
            
            <strong>ROUND 2 (15 min later):</strong><br>
            Previous round exists ‚Üí Query database for last round<br>
            Calculate time gap: 15 minutes<br>
            15 ‚â§ 60? YES ‚Üí gaming_session_id = 1 (SAME SESSION)<br>
            Processing time: ~2.2 seconds (extra 0.2s for query)<br><br>
            
            <strong>ROUND 10 (2 hours later):</strong><br>
            Previous round exists ‚Üí Query database for last round<br>
            Calculate time gap: 135 minutes<br>
            135 > 60? YES ‚Üí gaming_session_id = 2 (NEW SESSION)<br>
            Processing time: ~2.2 seconds<br><br>
            
            <strong>Everything else in all 8 stages is IDENTICAL!</strong>
        </div>
        
        <h2>üóÇÔ∏è Database Schema - Where Every Data Point Lives</h2>
        
        <div class="sql-query">
            <strong>Table 1: rounds</strong> (6 fields per round)<br>
            - round_id (PK, auto-increment)<br>
            - round_date (from filename)<br>
            - round_time (from filename)<br>
            - map_name (from filename)<br>
            - round_duration (from file content)<br>
            - winning_team (from file content)<br>
            - gaming_session_id ‚ö†Ô∏è (CALCULATED based on time gap)<br><br>
            
            <strong>Table 2: player_comprehensive_stats</strong> (52 fields √ó 8 players per round)<br>
            - player_stat_id (PK, auto-increment)<br>
            - round_id (FK ‚Üí rounds.round_id)<br>
            - player_name, player_guid, team<br>
            - kills, deaths, headshots, revives, heals, damage_given, damage_received<br>
            - assists, team_kills, self_kills, gibs<br>
            - accuracy, headshot_percentage, kd_ratio, kills_per_death<br>
            - ... (48 more fields) ...<br><br>
            
            <strong>Table 3: weapon_comprehensive_stats</strong> (9 fields √ó ~45 weapons √ó 8 players per round)<br>
            - weapon_stat_id (PK, auto-increment)<br>
            - round_id (FK ‚Üí rounds.round_id)<br>
            - player_guid<br>
            - weapon_name<br>
            - kills, deaths, headshots, accuracy<br>
            - shots_fired, shots_hit, damage_dealt<br><br>
            
            <strong>Table 4: processed_files</strong> (deduplication tracking)<br>
            - filename (PK)<br>
            - processed_at (timestamp)
        </div>
        
        <h2>üîó Data Relationships</h2>
        
        <div class="code-block">
            rounds.gaming_session_id = 1
            ‚Üì
            ‚îú‚îÄ rounds.round_id = 246 (Round 1)
            ‚îÇ  ‚Üì
            ‚îÇ  ‚îú‚îÄ player_comprehensive_stats (8 rows with round_id=246)
            ‚îÇ  ‚îî‚îÄ weapon_comprehensive_stats (360 rows with round_id=246)
            ‚îÇ
            ‚îî‚îÄ rounds.round_id = 247 (Round 2)
               ‚Üì
               ‚îú‚îÄ player_comprehensive_stats (8 rows with round_id=247)
               ‚îî‚îÄ weapon_comprehensive_stats (360 rows with round_id=247)
            
            When you query: "Show me gaming_session_id = 1"
            You get: Round 246 + Round 247 (complete map with both rounds!)
        </div>
        
        <div class="warning" style="margin-top: 40px; font-size: 1.1em; padding: 25px;">
            <strong>üéì Final Understanding:</strong><br><br>
            
            1. A <strong>ROUND</strong> is one half of a map (Allies attack OR Axis attack)<br>
            2. A <strong>MAP/MATCH</strong> contains 2 rounds (stopwatch mode swaps teams)<br>
            3. A <strong>GAMING SESSION</strong> is multiple maps played continuously (< 60 min gaps)<br>
            4. <strong>gaming_session_id</strong> groups rounds together so !last_session shows the right stats<br>
            5. Round 1 and Round 2 processing is <strong>99.9% IDENTICAL</strong><br>
            6. The <strong>ONLY difference</strong> is the gaming_session_id calculation (1 database query)<br>
            7. Everything else (parsing, validation, inserts, logging) is the same<br>
            8. Total pipeline: <strong>~781 data points in ‚Üí ~3,662 data points saved to database</strong>
        </div>
    </div>
</body>
</html>