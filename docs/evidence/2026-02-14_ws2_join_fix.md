# Evidence: WS2-001 Session Timing Join Hardening (`round_id`)
Date: 2026-02-13  
Workstream: WS2 (Timing Service Robustness)  
Task: `WS2-001`  
Status: `in_progress`

## Goal
Stop session timing comparison from using fragile `match_id` joins and use direct `round_id` linkage to Lua timing rows.

## Code Change
File:
1. `bot/services/timing_debug_service.py`

What changed:
1. Replaced session-level join:
   - old: `LEFT JOIN lua_round_teams l ON r.match_id = l.match_id AND r.round_number = l.round_number`
   - new: `LEFT JOIN LATERAL (...) l ON TRUE` using `WHERE lrt.round_id = r.id ORDER BY captured_at DESC LIMIT 1`
2. This ensures:
   - linkage follows canonical round identity (`round_id`)
   - single freshest Lua row per round
   - no accidental cross-session collisions from `match_id` drift.

## Test Coverage Added
File:
1. `tests/unit/test_timing_debug_service_session_join.py`

What it verifies:
1. Generated query contains `lrt.round_id = r.id`.
2. Legacy join fragment `r.match_id = l.match_id` is absent.
3. Session summary still renders and counts Lua coverage correctly.

## Validation Commands
Focused:
```bash
pytest -q tests/unit/test_timing_debug_service_session_join.py
```

Expanded:
```bash
pytest -q \
  tests/unit/test_timing_debug_service_session_join.py \
  tests/unit/test_round_linker_reasons.py \
  tests/unit/test_gametime_synthetic_round.py
```

Result:
1. all tests passed.

## Remaining Runtime Validation
1. Post a real session timing debug embed after fresh rounds and verify Lua durations appear for linked rounds.
2. Confirm no regressions in sessions where Lua rows are still missing (should show explicit missing count, not false matches).
