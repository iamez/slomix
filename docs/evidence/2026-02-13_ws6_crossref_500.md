# Evidence: WS6-001 Greatshot Crossref 500 Fix
Date: 2026-02-12  
Workstream: WS6 (Greatshot Reliability)  
Task: `WS6-001`  
Status: `done`

## Problem
`/greatshot/{demo_id}/crossref` could throw HTTP 500 when DB `winner_team` was numeric and code attempted string-only normalization (`lower()`).

## Code Change
File:
1. `website/backend/services/greatshot_crossref.py`

Patch:
1. Replaced direct `db_winner.lower().strip()` comparison with `_normalize_winner(db_winner)`.
2. Winner comparison now handles mixed DB types (`int`, `str`, `None`) safely.

## Test Coverage Added
File:
1. `tests/unit/test_greatshot_crossref.py`
2. `tests/unit/test_greatshot_router_crossref.py`
3. `tests/test_greatshot_api_integration.py` (crossref route coverage added; file uses optional integration deps)

Tests:
1. `test_normalize_winner_handles_mixed_types`
2. `test_match_single_round_handles_numeric_db_winner`
3. `test_enrich_with_db_stats_includes_tpm_and_time_minutes`
4. `test_get_crossref_returns_200_payload_when_no_match`
5. `test_get_crossref_returns_200_payload_when_match_exists`

## Validation Run
Command:
```bash
pytest -q tests/unit/test_greatshot_crossref.py
```

Result:
1. `3 passed`
2. Numeric DB winner case no longer crashes and still contributes winner confidence.

Extended validation:
```bash
pytest -q tests/unit/test_greatshot_crossref.py tests/unit/test_greatshot_router_crossref.py
```

Result:
1. `5 passed`
2. Crossref API-path behavior validated for both outcomes:
   - matched=false returns HTTP 200 payload
   - matched=true returns HTTP 200 payload

## Remaining Runtime Validation (Optional Follow-up)
1. Hit `/api/greatshot/{demo_id}/crossref` on recent demos in running environment.
2. Confirm frontend no longer shows `Cross-reference failed: HTTP 500`.

## Closure Decision
1. WS6-001 closure criteria satisfied in code + API-path test coverage.
2. Tracker status can move to `done`.
